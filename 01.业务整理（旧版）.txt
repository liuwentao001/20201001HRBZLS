pg_auto_task.日结任务(802);		--定时任务，每日凌晨1点
pg_auto_task.自动账务处理(803);		--定时任务，每日凌晨1点
pg_auto_task.当天日结任务(804);		--定时任务，每日22点
pg_auto_task.月末任务(805);		--定时任务，每月最后一天22点

procedure

	procedure pro_财务到账确认异常资料更新
		-- 1处理昨日有收支票zp、倒存dc、抹账mz 但未进入支票档cheque 问题  
		select pm.pid from payment pm where to_char(pdate, 'yyyymmdd') = to_char(trunc(sysdate)  , 'yyyymmdd') and ppayway in ('zp', 'dc', 'mz','ps') and pposition not like '03%'  --去掉银行的 and not exists (select 'a' from  cheque where chequeid =pm.pbatch ) --不存在cheque档中的
			select * into pm from payment where pid = v_pm.pid;
			select * into pdp from pay_daily_pid where pdpid = pm.pbatch; --payment与营销对账关联
			select * into yx from stpaymentyxdzreghd where hno = pdp.pdhid; --营销对账
			select b.* into pdy from pay_daily_pid a, pay_daily_yxhd b --营销与财务对账关联
			where a.pdhid = b.pddid and a.pdpid = pm.pbatch;
			select * into cw from stpaymentcwdzreghd where hno = pdy.pdhid; --财务对账
			select * into ci from custinfo where ciid = pm.ppriid;  --客户信息
			select smppvalue into v_bankno from sysmanapara where smpid = v_smfid and smppid = 'khzh'; --开户账号
			select smppvalue into v_bankname from sysmanapara where smpid = v_smfid and smppid = 'khyh';--开户银行
			select smppvalue into v_bankid from sysmanapara where smpid = v_smfid and smppid = 'khhh';--开户行号
			cq.chequeid            :=     v_pbatch;
			cq.enteringtime        :=     pm.pdatetime;
			cq.payername           :=     ci.ciname;
			cq.payertel            :=     ci.cimtel;
			cq.chequetype          :=     pm.ppayway;
			cq.chequemoney         :=     v_je;
			cq.chargelocation      :=     v_smfid;
			cq.chargename          :=     v_oper;
			cq.chargetime          :=      pm.pdatetime;
			cq.chequechargerid     :=     v_oper;
			cq.chequememo          :=     '后台自动新增资料';
			cq.chequestatus        :=     'n';
			cq.chequeoper          :=     v_oper;
			cq.chequesdate         :=     pm.pdatetime;
			cq.chequemcode         :=     pm.pcid;
			cq.chequecode          :=     '';
			cq.chequename          :=     ci.ciname;
			cq.chequebankname      :=     '';--相关支票需后续补入
			cq.chequebankid        :=     '';--
			cq.chequebankno        :=     '';--
			cq.cbankid             :=     v_bankid;
			cq.cbankname           :=     v_bankname;
			cq.cbankno             :=     v_bankno;
			cq.chequeflag          :=     'n';
			cq.chequecrflag        :=     v_chequecrflag; 
			if v_chequecrflag ='y' then cq.chequecrdate := pm.pdatetime; cq.chequecroper:= v_oper; end if ;
			cq.chequeyxno          := pdp.pdhid;   --营销对账单号
			cq.chequecwno          := pdy.pdhid ;  --财务对账单号
			insert into cheque values cq; 
		-- 2处理有进入财务对账审核，但payment中未更新 payment.PDZDATE 财务到账确认日期
			select pm.pid, p.pdpid,cw.hedate,cw.hshdate from stpaymentcwdzreghd cw,pay_daily_yxhd yx,pay_daily_pid p,payment pm where ...
			 if to_char(cw.hedate,'yyyymm') <> to_char(cw.hshdate,'yyyymm')   then  --如果审核日期与创建日期月份不一致则用创建日期否则用审核日期
				update payment set payment.pdzdate =v_pm.hedate  --创建日期 where pid =v_pm.pid;
			else update payment set payment.pdzdate =v_pm.hshdate --审核日期 where pid =v_pm.pid;

	procedure pro_抄表情况统计_hrb
		select to_char(sysdate, 'yyyy.mm') into PRO_MONTH from dual; --从系统中读取当前月

		delete from 基本信息中间表 where u_month=PRO_MONTH;
		insert into 基本信息中间表 select ... from meterinfo a ,meterdoc b where ...

		delete from 抄表情况统计_hrb where mmonth = PRO_MONTH;
		--按表插入当前月数据
		insert into 抄表情况统计_hrb select '1' lb,... from METERREAD,METERREADHIS,METERINFO,BOOKFRAME where...
		--按户插入数据
		insert into 抄表情况统计_hrb select '2' lb,... from METERREAD,METERREADHIS,METERINFO,BOOKFRAME where...

		---表务工单变化表 by ralph 2015.03.02
		select max(月份) into max_month from 表务工单变化表;
		if PRO_MONTH<>max_month then insert into 表务工单变化表(营业公司,月份,用水性质) select smfid,PRO_MONTH,pdpfid from SYSMANAFRAME t,(select pdpfid from PRICEDETAIL t where pdpiid='01') b where smftype='1' order by smfid,pdpfid;end if ;
		update  表务工单变化表 set 
		合户=(select count(ciid) from CUSTCHANGEDT t, CUSTCHANGEhd c where ...),
		销户拆表=(select count(MTDMCODE) from METERTRANSDT t, METERTRANShd c where ...),
		污水超标=(select count(ciid ) from TDSJDT t, TDSJHD c where ...),
		总表收免=(select count(ciid ) from CUSTCHANGEDT t, CUSTCHANGEhd c where ...),
		故障换表=(select count(mtdmcode  ) from METERTRANSDT t, METERTRANShd c where ...),
		周期换表=(select count(mtdmcode  ) from METERTRANSDT t, METERTRANShd c where ...),
		表故障=(select count(ciid ) from TDSJDT t, TDSJHD c where ...)
		where 月份=PRO_MONTH;

		delete from 用户工单变化表 where 月度=PRO_MONTH;
		--表故障
		insert into 用户工单变化表 select ... from TDSJDT t, TDSJHD c, meterinfo mi 
		where t.cmrdno = c.crhno and c.crhlb = '17' and crhshflag = 'Y' and to_char(crhshdate, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by  mi.mismfid,substr(NVL(mi.mibfid,'999999'), 1, 5),mi.mipfid;
		--更名
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'B' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid 
		group by mi.mismfid, substr(NVL(mi.mibfid,'999999'), 1, 5), mi.mipfid;
		--收费方式
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'C' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid 
		group by mi.mismfid, substr(NVL(mi.mibfid,'999999'), 1, 5), mi.mipfid;
		--过户
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'D' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--水价变更
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi 
		where t.ccdno = c.cchno and c.cchlb = 'E' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--用户水表信息维护
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'X' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') =PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--合收表
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'Y' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--低保户信息管理
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'Z' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--污水超标
		insert into 用户工单变化表 select ... from TDSJDT t, TDSJHD c, meterinfo mi
		where t.cmrdno = c.crhno and c.crhlb = 'w' and crhshflag = 'Y' and to_char(crhshdate, 'yyyy.mm') =PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;
		--用户状态
		insert into 用户工单变化表 select ... from CUSTCHANGEDT t, CUSTCHANGEhd c, meterinfo mi
		where t.ccdno = c.cchno and c.cchlb = 'W' and CCHSHFLAG = 'Y' and to_char(CCHSHDATE, 'yyyy.mm') = PRO_MONTH and ciid = mi.miid
		group by mi.mismfid, substr(NVL(mi.mibfid, '999999'), 1, 5), mi.mipfid;

	procedure sp_欠费中间表
		delete from 欠费中间表;
		insert into 欠费中间表 select ... from reclist rl, meterinfo mi,recdetail rd

	procedure pro_财务对账银行
		delete from 财务对账中间表 where to_char(pchkdate,'yyyy.mm')>=pro_month;
		insert into 财务对账中间表 select ...
			fgetycfs(pbatch, 'qc') qc,--期初预存
			fgetpaylist(pbatch, 'fs') fs,--本期发生
			fgetpaylist(pbatch, 'qm') qm,--期末预存
			fgetpaylist(pbatch, 'pay') pay,--付款金额 
			fgetpaylist(pbatch, 'znj') znj,--违约金
			fgetpaylist(pbatch, 'sf') sf,--水费
			fgetpaylist(pbatch, 'fjf') fjf,--附加费
			fgetpaylist(pbatch, 'ws') ws,--污水费
			fgetpaylistchar(pbatch, 'inv') inv,--发票号
			fgetpaylist(pbatch, 'sxf') sxf, --手续费
			preverseflag
		from payment, meterinfo

	procedure fgetycfs
		--期初
		if type='qc' then
			--单表
			select max(psavingqc) into v_qc from payment where pbatch=p_pbatch;
			--合收表
			select max(psavingqc) into v_qc from payment where pbatch=p_pbatch;
			v_qc := v_qc + pm.psavingqc;
		--期末
		elsif type='qm' then
			--单表
			select max(psavingqm) into v_qm from payment where pbatch=p_pbatch;
			--合收表
			select max(pid) into v_pid from payment where pbatch=p_pbatch and pmcode=v_pcode;
			select psavingqm into v_qm from payment where pid = v_pid;
		--付款金额
		elsif type='pay' then
			select sum(ppayment) into v_pay from payment where pbatch=p_pbatch;
		--手续费
		elsif type='sxf' then
			select sum(psxf) into v_pay from payment where pbatch=p_pbatch;
		--本期发生预存金额
		elsif type='fs' then
			select sum(psavingbq) into v_fs from payment where pbatch=p_pbatch;
		--水费
		elsif type='sf' then
			select nvl(sum(charge1),0) into v_sf from payment,reclist,view_reclist_charge_01 where pid=rlpid  and rlid=rdid and pbatch=p_pbatch;
		--附加费
		elsif type='fjf' then
			select nvl(sum(charge3),0) into v_fjf from payment,reclist,view_reclist_charge_01 where pid=rlpid  and rlid=rdid and pbatch=p_pbatch;
		--污水费
		elsif type='ws' then
			select nvl(sum(charge2),0) into v_ws from payment,reclist,view_reclist_charge_01 where pid=rlpid  and rlid=rdid and pbatch=p_pbatch;
		--违约金
		elsif type='znj' then
			select nvl(sum(rlznj),0) into v_znj from payment,reclist where pid=rlpid  and pbatch=p_pbatch;

	procedure fgetpaylist
		逻辑与fgetycfs相同

	procedure fgetpaylistchar
		--票据批次||号码
		select nvl(rtrim(max(ispcisno)),'') into v_inv from inv_info where batch=p_pbatch;

	procedure fgethszb
		--根据缴费交易批次查询合收主表号
		select max(ppriid) from payment where pbatch=p_pbatch ;

create or replace package pg_auto_task as errcode constant integer := -20012;

	procedure 单任务设置(p_id in number ,p_msg out varchar2);	/*查询job_list，执行dbms_job.isubmit(v_task.id, v_task.任务内容,v_next,v_task.运行间隔,true);*/
	procedure 状态注册(p_id varchar2);				/*查询job_list，更新 运行标志='y'*/
	procedure 状态注销(p_id varchar2);				/*查询job_list，更新 运行标志='n'*/
	function isrunning(p_id varchar2) return varchar2;		/*查询job_list.运行标志*/
	procedure 月结任务(p_id varchar2);				/*每月的倒数第二天，晚上21:00*/
	procedure 月末任务(p_id varchar2);				
	/*	每月最后一天，晚上23:00，
		pg_ewide_job_hrb.月末自动预存抵扣;
	*/
	procedure 日结任务(p_id varchar2);				
	/*	每天凌晨01:00
		pg_ewide_reportsum_hrb.综合月报(to_char(trunc(sysdate - 1),'yyyy.mm') );
		pg_ewide_job_hrb.验证码;
		清抄表月结标志;
		sp_欠费中间表;
		pro_财务对账银行;
		pg_ewide_reportsum_hrb.gis数据生成;
	 */
	procedure 当天日结任务(p_id varchar2);
	/*	每天22:00
		--系统登录信息，sys_host转sys_host_his
		pro_财务到账确认异常资料更新;
		pg_ewide_job_hrb.抄表月结;
		pro_抄表情况统计_hrb;
		--基建预存余额调拨统计 月末结转 (每个月最后一天执行)
		pg_ewide_job_hrb2.prc_rpt_allot_carryover( to_char(add_months(sysdate,-1),'yyyy.mm'),v_appcode,v_error);
		pg_ewide_job_hrb2.prc_rpt_allot_sum( to_char(sysdate,'yyyy.mm'),v_appcode,v_error);
	*/
	procedure 自动账务处理(p_id varchar2);
	/*	每天凌晨1点
		--自动扎帐
		zhongbe.sp_autobankzz;
		--本月最后一天,抄表月结
		pg_ewide_job_hrb.prc_monthlyinit;
		--删除手机抄表需要更新的资料
		delete from  meterinfo_sjcbup; 
	*/
	procedure 账务检查(p_id varchar2);		/*每天凌晨03:00*/
	procedure 清抄表月结标志 ;			/*trunc(last_day(sysdate)-8),trunc(last_day(sysdate)-4),update syspara t set t.spvalue = 'n' where t.spid='yjbz';
	procedure updatey001;				/*更新合收表月底结算日期参数,update syspara set spvalue = to_char(last_day(sysdate),'yyyymmdd') || '230000' where spid = 'y001';*/
	procedure 合同用户变更记录;
	/*
		insert into contractlog ... select ... from custchangehd a, custchangedt b, meterinfo m where ...
		--meterinfo.mihtbh		合同编号
		--meterinfo.zfdate		合同作废日期
		--custchangehd.cchshflag	审核标志
		--custchangehd.cchshdate	审核日期
		--custchangedt.ciname <> custchangedt.ciname2	用户名，招牌名
		--custchangedt.ciadr  <> custchangedthis.ciadr	用户地址
		--custchangedt.mipfid <> custchangedthis.mipfid	行业分类
	*/
end pg_auto_task;

create or replace package "pg_ewide_job_hrb" as errcode constant integer := -20012;

	procedure 月初处理;
	/*	月初处理
		pg_ewide_raedplan_01.createmr(v_smfid.smfid,v_readmonth,v_bfid.bfid);
	*/
	procedure prc_monthlyinit ;
	/*	月初处理测试版
		pg_ewide_raedplan_01.createmr2(rec_smf.smfid,v_readmonth,null);
	*/
	procedure 抄表月结;
	/*
		pg_ewide_raedplan_01.carryforward_mr(v_smfid.smfid,v_readmonth,'system','y');
	*/
	procedure 账务月结;
	/*
		pg_ewide_raedplan_01.carryforpay_mr(v_smfid.smfid,v_rlmonth,'system','y');
	*/
	procedure 自动算费;
	/*
		pg_ewide_meterread_01.submit(v_bfid);
	*/
	procedure 自动预存抵扣(v_smfid in varchar2);
	/*
		select 
			rlid	总账编号
			rlje	应收金额
			pg_ewide_pay_01.getznjadj(rlid,sum(rlje),rlgroup,max(rlzndate),rlsmfid,trunc(sysdate)	--计算违约金
		from reclist, meterinfo where ...
		
		mipriflag = 'y' --合收表标志(y-合收表标志,n-非合收主表 )

		select sum(misaving) 预存款余额 from meterinfo		--总预存
		select sum(rlje) 应收金额 from reclist			--总欠费
		where rlprimcode = mi.mipriid
			and rlbadflag = 'n'				--呆帐标志（y :呆坏帐，o:呆坏帐审批中，n:正常帐）
			and rlreverseflag = 'n'				--冲正标志（n为正常，y为冲正）
			and rlpaidflag = 'n';				--销帐标志(y/n)

		v_rlidlist  := v_rlidlist || v_rlid || ',';	--总账编号
		v_pmisaving := v_pmisaving - (v_rlje + v_znj);	--预存款余额
		v_rljes     := v_rljes + v_rlje;		--应收金额
		v_znjs      := v_znjs + v_znj;			--违约金
		
		总预存 >= 总欠费       /*合收表*/
			insert into pay_para_tmp values (v_hs_meter.miid, v_hs_rlids, v_hs_rlje, 0, v_hs_znj)	--插入pay_para_tmp 表做合收表销账准备
			pg_ewide_pay_01.pos('02', --销帐方式 01 单表缴费 02 合收表缴费 03 多表缴费
				mi.mismfid, --缴费机构
				'system', --收款员
				v_rlidlist || '|', --应收流水串
				nvl(v_rljes, 0), --应收总金额
				nvl(v_znjs, 0), --销帐违约金
				0, --手续费
				0, --实际收款
				pg_ewide_pay_01.paytrans_预存抵扣, --缴费事务
				mi.mipriid, --水表资料号
				'xj', --付款方式
				mi.mismfid, --缴费地点
				fgetsequence('entrustlog'), --销帐批次
				'n', --是否打票  y 打票，n不打票， r 应收票
				null, --发票号
				'n' --控制是否提交（y/n）
				);
		else			/*单表*/
			pg_ewide_pay_01.pos('01', --销帐方式 01 单表缴费 02 合收表缴费 03 多表缴费
				mi.mismfid, --缴费机构
				'system', --收款员
				v_rlidlist || '|', --应收流水串
				nvl(v_rljes, 0), --应收总金额
				nvl(v_znjs, 0), --销帐违约金
				0, --手续费
				0, --实际收款
				pg_ewide_pay_01.paytrans_预存抵扣, --缴费事务
				mi.miid, --水表资料号
				'xj', --付款方式
				mi.mismfid, --缴费地点
				fgetsequence('entrustlog'), --销帐批次
				'n', --是否打票  y 打票，n不打票， r 应收票
				null, --发票号
				'n' --控制是否提交（y/n）
				);
	*/
	procedure 验证码;		/*update operaccnt.oaic 随机5位数字*/
	procedure 月售水情况归档;
	/*
		源表：	rpt_sum_detail
		目标表：rpt_hrbzls_rlcharge 月售水情况统计
		
		源表：	rpt_hrbzls_rlcharge
		目标表：rpt_hrbzls_rlchargenew
	*/
	procedure 月售水情况归档_1(p_mouth in varchar2);
	/*
		源表：	v_可修改售水量中间表
		目标表：rpt_hrbzls_rlcharge

		update rpt_hrbzls_rlcharge rpt set 
			rpt.rlnum =	pg_ewide_job_hrb2.f_getallotnumber(rlsmfid,rlmonth),
			rpt.rlsl =	pg_ewide_job_hrb2.f_getallotsl(rlsmfid,rlmonth),
			rpt.r ljsje =	pg_ewide_job_hrb2.f_getallotmoney(rlsmfid,rlmonth)
		where rlmonth = v_rlmonth and rlrfname = '基建';

		源表：	rpt_hrbzls_rlcharge
		目标表：rpt_hrbzls_rlchargenew
	*/
	procedure 月售水情况归档_old
	/*
		insert into rpt_hrbzls_rlcharge select ... from reclist rl, meterinfo mi, view_reclist_charge rd, payment pm where ...
		priceframe		费率结构信息
		priceframe.pfname	用水性质
		pricedetail		费率明细
	*/
end;

package pg_ewide_pay_01
	-- purpose : 缴费事务包
	type varchar_idxtab is table of varchar2(500) index by binary_integer;
	-- public constant declarations
	全公司统一标准收滞纳金 varchar2(100); --全公司统一标准收滞纳金(y),各营业所标准收滞纳金(n)
	v_project varchar2(10); --项目编号
	--错误代码
	errcode  constant integer := -20012;
	nocust   constant integer := -20013;
	noarrear constant integer := -20014;
	noenough constant integer := -20015;
	--常量参数
	paytrans_pos      constant char(1) := 'p'; --自来水柜台缴费
	paytrans_ds       constant char(1) := 'b'; --银行实时代收
	paytrans_dsde     constant char(1) := 'e'; --银行实时代收单边帐补销（对帐结果补销隔日发起）
	paytrans_dk       constant char(1) := 'd'; --代扣销帐
	paytrans_ts       constant char(1) := 't'; --托收票据销帐
	paytrans_sav      constant char(1) := 's'; --自来水柜台独立预存
	paytrans_banksav  constant char(1) := 'q'; --自来水柜台独立预存
	paytrans_inv      constant char(1) := 'i'; --走收票据销帐
	paytrans_预存抵扣 constant char(1) := 'u'; --算费过程即时预存抵扣
	paytrans_cr     constant char(1) := 'c'; --其它所有未独立业务冲销（销帐冲正单据发起）
	paytrans_bankcr constant char(1) := 'x'; --实时代收冲销（银行当日冲销发起）
	paytrans_dscr   constant char(1) := 'r'; --实时代收单边帐冲销
	paytrans_adj    constant char(1) := 'v'; --减量退费：退费贷帐事务(cr)、借帐补销事务(de)
	paytrans_稽查   constant char(1) := 'f'; --稽查罚款
	paytrans_追量   constant char(1) := 'z'; --追量
	paytrans_预留   constant char(1) := 'y'; --预留
	paytrans_余度   constant char(1) := 'a'; --余度
	paytrans_工程款 constant char(1) := 'g'; --工程款
	paytrans_价差   constant char(1) := 'j'; --价差
	paytrans_水损   constant char(1) := 'k'; --水损
	debit  constant char(2) := 'de'; --借方
	credit constant char(2) := 'cr'; --贷方
	ctl_paypart constant varchar2(10) := 'full'; --满付
	cal_days    constant integer := 3; --计费缓冲日（计算滞纳金）

	--待销帐应收包
	subtype rl_type is reclist%rowtype;
	type rl_table is table of rl_type;

	--供调用查询欠费过程（同与inq101）
	function getrec(p_mid in varchar2) return number;		--p_mid水表档案号
		select * into mi from meterinfo t where miid = p_mid;	
		select sum(rlje + getznjadj(rlid,rlje,rlgroup,rlzndate,mi.mismfid,trunc(sysdate)))into result	--应收金额+违约金
		from reclist t			--应收总帐明细
		where t.rlpaidflag = 'n'	--销帐标志(y/n)
			and rlcd = 'de'		--借贷方向
			and rloutflag = 'n';	--发出标志(y-发出 n-未发出)
		return nvl(result, 0);

	--取滞纳金宽限比例
	function fgetznscale(p_type    in varchar2, --滞纳金类别
		       p_smfid   in varchar2, --营业所
		       p_rlgroup in varchar2 --应收分帐号
		       ) return number;
		select nvl(zpvalue, 0) into v_ret
		from	znjparme t		--滞纳金参数表
		where	zptype = p_type
			and zpsmfid = p_smfid
			and zpgroup = p_rlgroup
			and zpflag = 'y';	--有效标志
		return v_ret;

	--取滞纳金宽限天数
	function fgetznday(p_type    in varchar2, --滞纳金类别
		     p_smfid   in varchar2, --营业所
		     p_rlgroup in varchar2 --应收分帐号
		     ) return number;
		select nvl(zpday, 0)into v_ret
		from znjparme t
		where zptype = p_type and zpsmfid = p_smfid and zpgroup = p_rlgroup and zpflag = 'y';
		return v_ret;

	--违约金计算子函数（含节假日规则，不含减免规则）
	function getznj(p_smfid   in varchar2, --营业所
		  p_rlgroup in varchar2, --应收分帐号
		  p_sdate   in date, --起算日'计入'违约日
		  p_edate   in date, --终算日'不计入'违约日
		  p_je      in number) --违约金本金
		return number;
		if v_project = 'tm' then  	--天门项目
			return pg_ewide_pay_tm.getznj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);
		elsif v_project = 'lyg' then	--连云港项目
			return pg_ewide_pay_lyg.getznj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);
		elsif v_project = 'hrb' then	--哈尔滨项目
			return pg_ewide_pay_lyg.getznj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);

	--违约金计算（含节假日规则，含减免规则）
	function getznjadj(p_rlid     in varchar2, --应收流水
		     p_rlje     in number, --应收金额
		     p_rlgroup  in number, --应收组号
		     p_rlzndate in date, --滞纳金起算日
		     p_smfid    varchar2, --水表营业所
		     p_edate    in date --终算日'不计入'违约日
		     ) return number;
		if v_project = 'tm' then  	--天门项目
			return pg_ewide_pay_tm.getznjadj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);
		elsif v_project = 'lyg' then	--连云港项目
			return pg_ewide_pay_lyg.getznjadj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);
		elsif v_project = 'hrb' then	--哈尔滨项目
			return pg_ewide_pay_lyg.getznjadj(p_smfid,p_rlgroup,p_sdate,p_edate,p_je);

	--自来水柜台缴费
	function pos(p_type     in varchar2, --销帐方式 01 单表缴费 02 合收表缴费 03 多表缴费
	       p_position in payment.pposition%type, --缴费机构
	       p_oper     in payment.pper%type, --收款员
	       p_rlids    in varchar2, --应收流水串
	       p_rlje     in number, --应收总金额
	       p_znj      in number, --销帐违约金
	       p_sxf      in number, --手续费
	       p_payje    in number, --实际收款
	       p_trans    in payment.ptrans%type, --缴费事务
	       p_miid     in payment.pmid%type, --水表资料号
	       p_fkfs     in payment.ppayway%type, --付款方式
	       p_paypoint in payment.ppaypoint%type, --缴费地点
	       p_paybatch in payment.pbatch%type, --销帐批次
	       p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
	       p_invno    in varchar2, --发票号
	       p_commit   in varchar2 --控制是否提交（y/n）
	       ) return varchar2;

		| 项目                                                         | 销帐方式                      | 调用                               |
		| ------------------------------------------------------------ | ----------------------------- | ---------------------------------- |
		| v_project = 'tm'  --天门                                     | p_type = '01'                 | pg_ewide_pay_tm.f_pos_1meter       |
		| v_project = 'tm'  --天门                                     | p_type = '02'                 | pg_ewide_pay_tm.f_pos_mult_hs      |
		| v_project = 'tm'  --天门                                     | p_type = '03'                 | pg_ewide_pay_tm.f_pos_mult_m       |
		| v_project = 'lyg' --连云港                                   | p_type = '01'                 | pg_ewide_pay_tm.f_pos_1meter       |
		| v_project = 'lyg' --连云港                                   | p_type = '02'                 | pg_ewide_pay_lyg.f_pos_mult_hs     |
		| v_project = 'lyg' --连云港                                   | p_type = '03'                 | pg_ewide_pay_lyg.f_pos_mult_m      |
		| v_project = 'hrb' and p_payje>-0.1 and p_payje<0.1 and p_rlje=0 and p_trans in ('s','b') --哈尔滨 | p_type = '01' --01 单表缴费   | [pg_ewide_pay_hrb.f_pos_1meter]()  |
		| v_project = 'hrb' and p_payje>-0.1 and p_payje<0.1 and p_rlje=0 and p_trans in ('s','b') --哈尔滨 | p_type = '02' --02 合收表缴费 | [pg_ewide_pay_hrb.f_pos_mult_hs]() |
		| v_project = 'hrb' and p_payje>-0.1 and p_payje<0.1 and p_rlje=0 and p_trans in ('s','b') --哈尔滨 | p_type = '03' --03 多表缴费   | [pg_ewide_pay_hrb.f_pos_mult_m]()  |

	--支付宝缴费
	function pos_zfb (
	       p_payje    in number, --实际收款
	       p_pbseqno  in varchar2,  --支付宝流水
	       p_miid     in varchar2 --水表资料号
	       ) return varchar2;

		| 条件                                                         | 调用                                   |
		| ------------------------------------------------------------ | -------------------------------------- |
		| v_mipriflag='n'and (p_payje+v_misaving)>=v_rlje --非合收表，实收+预存>=应收 | [pg_ewide_pay_hrb.f_pos_1meter_zfb]()  |
		| 其他                                                         | [pg_ewide_pay_hrb.f_pos_mult_hs_zfb]() |
		| ?????????                                                    | [pg_ewide_pay_hrb.f_pos_mult_m]()      |

	--微信缴费
	function pos_wx (
	       p_payje    in number, --实际收款
	       p_pbseqno  in varchar2,  --交易流水
	       p_miid     in varchar2, --水表资料号
	       p_bz       in varchar2, --缴费来源
	       p_pwseqno  in varchar2,  --微信流水
	       p_date     in varchar2       --交易申请时间
	       ) return varchar2;
		| 条件                                                         | 调用                                   |
		| ------------------------------------------------------------ | -------------------------------------- |
		| v_mipriflag='n'and (p_payje+v_misaving)>=v_rlje --非合收表，实收+预存>=应收 | [pg_ewide_pay_hrb.f_pos_1meter_zfb]()  |
		| 其他                                                         | [pg_ewide_pay_hrb.f_pos_mult_hs_zfb]() |
		| ?????????                                                    | [pg_ewide_pay_hrb.f_pos_mult_m]()      |


	--实收冲正按 缴费流水 payment.pid
	procedure sp_paidbak(p_pid      in payment.pid%type, --实收流水
		       p_position in varchar2, --冲正单位地点
		       p_oper     in varchar2, --冲正操作员
		       p_payee    in varchar2, --冲正付款员
		       p_trans    in varchar2, --冲正事务
		       p_memo     in varchar2, --冲正备注
		       p_iffp     in varchar2, --是否打负票
		       p_invno    in varchar2, --票号
		       p_crpbatch in varchar2, --冲正批次流水
		       p_commit   in varchar2 --提交标志
		       );
		meterinfo	户表信息
		payment		付款交易
		paidlist	销帐流水
		paiddetail	实收帐明细
		reclist		应收总帐明细
		recdetail	应收帐明细

		payment notfound								实收帐不存在
		payment.ptrans <> 's' and pold.pcd <> 'de'	自来水柜台独立预存	借方	此帐已补冲了，不能再冲
		pold.pflag <> 'y'				实收标志（全部为y.暂无启用）	此帐已补冲了，不能再冲
		meterinfo notfound								用户不存在

		fgetsequence('payment');						查询payment的seq
		tools.fgetpaydate(rl.rlsmfid);	rl.rlsmfid:营销公司(sysmanaframe )	return trunc(sysdate)
		tools.fgetpaymonth(p_position)						return to_char(sysdate, 'yyyy.mm');
		tools.fgetpaymonth(rl.rlsmfid)						return to_char(sysdate, 'yyyy.mm');

		pl.psavingqc = meterinfo.misaving		--期初预存余额
		pl.psavingbq = -payment.psavingbq		--本期发生预存金额
		pl.psavingqm = meterinfo.misaving + pl.psavingbq	--期末预存余额
			pl.psavingqm < 0			--输出：当前预存余额已不足退减当时预存增加额，不能冲正
		pl.ppayment = -payment.ppayment		--付款金额
		...
			
		update payment t set t.pflag = 'n' where current of c_pold;	--pflag，实收标志
		insert into paidlist values pl;
		update paidlist set plflag = 'n' where current of c_plold;
		update reclist t set rlpaidflag = 'n',rlpaidje   = 0,rlpaiddate = null,rlmiuiid   = p.pilid where current of c_rl;
	        insert into paiddetail values pd;
	        update paiddetail set pdflag = 'n', pdmemo = p_memo where current of c_pdold;
	        update recdetail t set rdpaidflag = 'n', t.rdilid = p.pilid where current of c_rd
		update meterinfo t set t.misaving = p.psavingqm where current of c_mi;

	--实收冲正按 缴费批次 payment.pbatch
	procedure sp_paidbak_bypbatch(p_pbatch   in payment.pbatch%type, --实收流水
				p_position in varchar2, --冲正单位地点
				p_oper     in varchar2, --冲正操作员
				p_payee    in varchar2, --冲正付款员
				p_trans    in varchar2, --冲正事务
				p_memo     in varchar2, --冲正备注
				p_iffp     in varchar2, --是否打负票
				p_invno    in varchar2, --票号
				p_crpbatch in varchar2, --冲正批次流水
				p_commit   in varchar2 --提交标志
				);
		调用procedure sp_paidbak

	--实收冲正,按批次冲正：
	function f_payback_by_batch(p_batch    in payment.pbatch%type,
			      p_position in payment.pposition%type,
			      p_oper     in payment.pper%type,
			      p_paypoint in payment.ppaypoint%type,
			      p_trans    in payment.ptrans%type) return varchar2;
		c_pold%notfound			实收帐不存在！
		pold.pmid = pold.ppriid and fgetpsaving(p_batch, 'dq') < pold.psavingbq			本次冲正会造成负预存，不允许冲正！
		pold.ppayment < 0 and pold.preverseflag = 'n'		--退预存记录不允许冲正！
		
		调用pg_ewide_pay_hrb.f_payback_by_batch

	--支付宝退费
	function reverse_zfb(p_batch    in payment.pbatch%type)return varchar2;

	--微信退费
	function reverse_wx(p_batch in payment.pbatch%type, p_bz in varchar2) return varchar2;
end;

create or replace package "pg_ewide_pay_hrb" is
	-- purpose : 缴费事务包
	-- 全局类型说明
	type varchar_idxtab is table of varchar2(500) index by binary_integer;
	-- 全局常量说明
	全公司统一标准收滞纳金 varchar2(100); --全公司统一标准收滞纳金(y),各营业所标准收滞纳金(n)
	--错误代码
	errcode  constant integer := -20012;
	nocust   constant integer := -20013;
	noarrear constant integer := -20014;
	noenough constant integer := -20015;
	--常量参数
	paytrans_pos      constant char(1) := 'p'; --自来水柜台缴费
	paytrans_ds       constant char(1) := 'b'; --银行实时代收
	paytrans_bsav     constant char(1) := 'w'; --银行实时单缴预存
	paytrans_dsde     constant char(1) := 'e'; --银行实时代收单边帐补销（对帐结果补销隔日发起）
	paytrans_dk       constant char(1) := 'd'; --代扣销帐
	paytrans_ts       constant char(1) := 't'; --托收票据销帐
	paytrans_sav      constant char(1) := 's'; --自来水柜台独立预存
	paytrans_inv      constant char(1) := 'i'; --走收票据销帐
	paytrans_预存抵扣 constant char(1) := 'u'; --算费过程即时预存抵扣
	paytrans_ycdb     constant char(1) := 'k'; --预存调拨
	paytrans_cr     constant char(1) := 'c'; --其它所有未独立业务冲销（销帐冲正单据发起）
	paytrans_bankcr constant char(1) := 'x'; --实时代收冲销（银行当日冲销发起）
	paytrans_dscr   constant char(1) := 'r'; --实时代收单边帐冲销
	paytrans_adj    constant char(1) := 'v'; --减量退费：退费贷帐事务(cr)、借帐补销事务(de)
	paytrans_稽查   constant char(1) := 'f'; --稽查罚款
	paytrans_追量   constant char(1) := 'z'; --追量
	paytrans_预留   constant char(1) := 'y'; --预留
	paytrans_余度   constant char(1) := 'a'; --余度
	paytrans_工程款 constant char(1) := 'g'; --工程款
	paytrans_价差   constant char(1) := 'j'; --价差
	paytrans_水损   constant char(1) := 'k'; --水损
	debit  constant char(2) := 'de'; --借方
	credit constant char(2) := 'cr'; --贷方
	ctl_paypart constant varchar2(10) := 'full'; --满付
	cal_days    constant integer := 3; --计费缓冲日（计算滞纳金）
	--待销帐应收包
	subtype rl_type is reclist%rowtype;
	type rl_table is table of rl_type;

	function getrec(p_mid in varchar2) return number;
		--实时欠费金额（含违约金）
		--返回总金额包括违约金
		select sum(rlje + getznjadj(rlid,rlje,rlgroup,rlzndate,mi.mismfid,trunc(sysdate)))
		from reclist t where t.rlpaidflag = 'n' and rlcd = 'de' and rloutflag = 'n';

	function getrec(p_mid   in varchar2,
		p_recje out reclist.rlje%type,
		p_znj   out reclist.rlznj%type) return number;
		--实时欠费金额
		--返回总金额包括违约金，同时有2个输出参数（应收金额 和 违约金）
		--mi.mismfid，使用当前营业所号计算违约金
		select nvl(sum(t.rlje), 0),nvl(sum(getznjadj(t.rlid,t.rlje,t.rlgroup,t.rlzndate,mi.mismfid,trunc(sysdate))),0)
		from reclist t where t.rlmid = p_mid and t.rlpaidflag = 'n' and rloutflag = 'n';

	--取滞纳金宽限比例
	function fgetznscale(p_type    in varchar2, --滞纳金类别
		       p_smfid   in varchar2, --营业所
		       p_rlgroup in varchar2 --应收分帐号
		       ) return number;
		--znjparme 滞纳金参数表
		--zpflag 有效标志
		select nvl(zpvalue, 0) from znjparme t
		where zptype=p_type and zpsmfid=p_smfid and zpgroup=p_rlgroup and zpflag='y';

	--取滞纳金宽限天数
	function fgetznday(p_type    in varchar2, --滞纳金类别
		     p_smfid   in varchar2, --营业所
		     p_rlgroup in varchar2 --应收分帐号
		     ) return number;
		--znjparme 滞纳金参数表
		--zpflag 有效标志
		select nvl(zpday, 0) from znjparme t
		where zptype=p_type and zpsmfid=p_smfid and zpgroup=p_rlgroup and zpflag='y';

	--违约金计算子函数（含节假日规则，不含减免规则）
	function getznj(p_smfid   in varchar2, --营业所
		  p_rlgroup in varchar2, --应收分帐号
		  p_sdate   in date, --起算日'计入'违约日
		  p_edate   in date, --终算日'不计入'违约日
		  p_je      in number) --违约金本金
		  return number;
		--znjparme 滞纳金参数表	
		----znjparme.zpvalue 滞纳金比例，
		----znjparme.zpday 宽限天数
		--calendar 日历		
		----calendar.califhol 节假日
		--取宽限天数、比例参数
		select zpvalue,zpday from znjparme t where zpgroup = p_rlgroup and zpflag = 'y';
		--滞缴期--计起算日当天、不计算缴费当日
		select count(*)-sum(califhol)-zpday from calendar where caldate >= trunc(p_sdate) and caldate <= trunc(p_edate);
	
	--违约金计算（含节假日规则，含减免规则）
	function getznjadj(p_rlid     in varchar2, --应收流水
		     p_rlje     in number, --应收金额
		     p_rlgroup  in number, --应收组号
		     p_rlzndate in date, --滞纳金起算日
		     p_smfid    varchar2, --水表营业所
		     p_edate    in date --终算日'不计入'违约日
		     ) return number;
		znjadjustlist 滞纳金减免明细
		reclist 应收总帐明细
		je=getznj(p_smfid, p_rlgroup, p_rlzndate, p_edate, p_rlje)
		| 条件                | 描述         | 返回值                                                       |
		| ------------------- | ------------ | ------------------------------------------------------------ |
		| reclist.rlznj>0     |              | reclist.rlznj                                                |
		| zal.zalmethod = '1' | 目标金额减免 | nvl(zal.zalvalue, je)                                        |
		| zal.zalmethod = '2' | 比例金额减免 | je*(1+zal.zalvalue)                                          |
		| zal.zalmethod = '3' | 差额减免     | je+zal.zalvalue                                              |
		| zal.zalmethod = '4' | 调整起算日期 | getznj(p_smfid, p_rlgroup, znjadjustlist.zaldate, p_edate, p_rlje) |

	function f_set_rec_tmp(p_rlids in varchar2, p_miid in varchar2)return number;
		/*******************************************************************************************
		函数名：f_set_rec_tmp
		用途：为销帐核心过程准备待处理应收数据
		处理过程：
		1、如果是全部销帐，则直接将相应记录从reclist拷贝到临时表
		2、如果是部分记录销帐，则根据应收帐流水串，逐条从reclist拷贝到临时表
		3、计算违约金、手续费等销帐前计算的金额信息
		参数：
		1、部分销帐，p_rlids 应收流水串，格式：xxxxxxxxxx,xxxxxxxxxx,xxxxxxxxxx| 逗号分隔
		2、全部销帐：_rlids='all'
		3、p_miid  水表资料号
		返回值：成功--应收流水id个数，失败--0
		*******************************************************************************************/

	function f_chk_list(p_rlje   in number, --应收金额
		      p_znj    in number, --销帐违约金
		      p_sxf    in number, --手续费
		      p_payje  in number, --实际收款
		      p_saving in meterinfo.misaving%type --水表资料号
		      ) return number;
		/*******************************************************************************************
		f_chk_list
		用途：检查销帐金额是否相符
		参数： 应缴，手续费，违约金，实收金额，预存期初
		返回值：成功--0，失败---非零
		*******************************************************************************************/
		select nvl(sum(t.rlje),0),nvl(sum(t.rlznj),0),nvl(sum(t.rlsxf),0) from reclist_1meter_tmp t
		p_rlje >= 0 and (p_rlje <> sum(t.rlje) or p_sxf <> sum(t.rlsxf))  则 RAISE ERR_NOMATCH

	function f_pay_core(p_position in payment.pposition%type, --缴费机构
		      p_oper     in payment.pper%type, --收款员
		      p_miid     in payment.pmid%type, --水表资料号
		      p_rlje     in number, --应收金额
		      p_znj      in number, --销帐违约金
		      p_sxf      in number, --手续费
		      p_payje    in number, --实际收款
		      p_trans    in payment.ptrans%type, --缴费事务
		      p_fkfs     in payment.ppayway%type, --付款方式
		      p_paypoint in payment.ppaypoint%type, --缴费地点
		      p_paybatch in varchar2, --缴费事务流水
		      p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
		      p_invno    in payment.pilid%type, --发票号
		      p_payid    out payment.pid%type --实收流水，返回此次记账的实收流水号
		      ) return varchar2;
		/*******************************************************************************************
		函数名：f_pay_core 用途：核心销帐过程，所有针销帐业务都最终调用本函数实现
		返回值：000---成功其他--失败
		前置条件：在临时表reclist_1meter_tmp中，准备好所有【待销帐数据】
		*******************************************************************************************/
		用到的表
		meterinfo
		reclist
		recdetail
		reclist_1meter_tmp
		custinfo
		------step 10: 检查各种金额
		------step 20: 记录实收帐
			--如果 月末自动预存抵扣 运行,则销帐日期取系统参数!
				if pg_auto_task.isrunning('805') = 'y' then nvl(fsyspara('y001'),to_char(sysdate,'yyyymmddhh24miss'))
				else sysdate
			--计算
				vp.prcreceived := vp.ppayment - vp.pchange;
				--预存期末=实收+预存起初-应销水费-手续费-违约金
				vp.psavingqm := vp.ppayment + vp.psavingqc - vp.pspje - vp.pznj - vp.psxf;
				--预存本期发生=期末-期初
				vp.psavingbq := vp.psavingqm - vp.psavingqc;
			--如果银行模拟缴费 要虚拟一个交易流水号(否则不能参与正确对账)
				if p_trans = 'q' then vp.pbseqno := to_char(sysdate,'yyyymmddhh24miss') || '#mn'; end if;
			
			insert into payment values vp;
			----是否单缴预存？欠费金额为0 ，则为单缴预存，无需处理应收细节，直接跳转
				if p_rlje = 0 then goto step 50; end if;
		------step 30: 应收总账销帐处理
			调用f_pset_reclist(p_payje,vp.pid,mi.misaving,vp.pdate,vp.pper);
			--再从临时表更新到正式表
			update reclist t set ... = (select ... from reclist_1meter_tmp s where t.rlid = s.rlid)
			where t.rlid in (select a.rlid from reclist_1meter_tmp a);
		------step 40: 应收明细帐销帐处理----------------------------------------------------------
		------step 50: 预存余额处理-----------------------------------------------------------
			if vp.psavingbq <> 0 then update meterinfo t set t.misaving = vp.psavingqm, t.mipaymentid = p_payid where current of c_mi;
		------step 60: 提交事务---------------------------------------------------------

	function f_pset_reclist(p_payje   in number, --实收金额
			  p_pid     in payment.pid%type, --实收流水
			  p_remaind in number, --当前预存
			  p_date    date, --销帐日期
			  p_pper    in payment.pper%type --收款员
			  ) return number;
		/*******************************************************************************************
		函数名：f_pset_reclist
		用途： 本函数由核心销帐过程调用，调用前【待销帐记录】已经在从reclist 中拷贝到临时表中，本函数对临时表进行逐条销帐处理，
		返回主程序后，核心销帐过程根据临时表更新reclist ，达到快捷销帐目的。
		     逐条处理的目的：将收费金额和预存逐条分配到应收帐记录上，方便打票处理
		例子： a水表，3个月欠费110元，期初预存30元，本次收费100元，违约金5元，应收销帐记录如下：
		月     份       预初     本次收费    应缴水费     违约金    预存期末   预存发生
		2011.06        30        100           30             1               99             69
		2011.08        99         0              40             2                57           -42
		2011.10        57         0              40             2                15           -42
		参数：p_payje number，实收金额
		   p_remaind number 当前预存
		前置条件：reclist_1meter_tmp 里rlid, rlje,rlznj ，rlsxf 都已算好了。
		*******************************************************************************************/
		----各类金额处理，以下赋值语句次序不可随意变动--------------------------------------------------------------------
		v_rl.rlznj := nvl(v_rl.rlznj, 0);
		v_rl.rlsxf := nvl(v_rl.rlsxf, 0);
		v_rl.rlpaidje   := v_je_tmp; --销本应收记录时的收费金额
		v_rl.rlsavingqc := v_qc; --销本应收记录时的预存期初
		--销本应收记录后的预存期末
		v_rl.rlsavingqm := v_rl.rlpaidje + v_rl.rlsavingqc - v_rl.rlje - v_rl.rlznj - v_rl.rlsxf;
		----销本应收记录时的预存发生
		v_rl.rlsavingbq := v_rl.rlsavingqm - v_rl.rlsavingqc;
		v_je_tmp := 0; --除第一条外，后续每条的实收金额都是0
		v_qc     := v_rl.rlsavingqm; --上一条期末，成为下一条期初
		
		--更新临时应收表
		update reclist_1meter_tmp t set ... where t.rlid = v_rl.rlid;

	function f_set_cr_reclist(pm in payment%rowtype --负的实收
			    ) return number;
		/*******************************************************************************************
		函数名：f_set_cr_reclist
		用途： 本函数由核心实收冲正帐过程调用，调用前【待冲正应收记录记录】已经在从reclist 中拷贝到临时表中，本函数对临时表进行逐条冲正处理，
		返回主程序后，核心冲正过程根据临时表更新reclist ，达到快捷冲正目的。
		       逐条处理的目的：将冲正金额和预存逐条分配到应收帐记录上，预存管理
		例子： a水表，个月欠费110元，期初预存30元，本次收费100元，违约金5元，应收冲正后记录如下：
		月     份       预初     本次收费    应缴水费     违约金    预存期末   预存发生
		原  2011.06         30          100           110         5        15         15
		新  2011.06         30         -100           -110       -5        15        -15
		参数：pm 负实收 。
		*******************************************************************************************/
		--销本应收记录后的预存期末
		v_rl.rlsavingqm := v_qc;
		v_rl.rlsavingbq := -v_rl.rlsavingbq;
		v_rl.rlsavingqc := v_rl.rlsavingqm - v_rl.rlsavingbq; --销本应收记录时的预存期初
		----销本应收记录时的预存发生
		v_qc := v_rl.rlsavingqc; --上一条期末，成为下一条期初
		---更新临时应收表
		update reclist_1meter_tmp t
		 set t.rlid    = fgetsequence('reclist'),
		     t.rlmonth = tools.fgetrecmonth(t.rlmsmfid), --当前              帐务月份
		     t.rldate  = tools.fgetrecdate(t.rlmsmfid), --当前              帐务日期
		     t.rldate  = pm.pdate, --当前              帐务日期*/
		     t.rlreadsl       = 0 - t.rlreadsl, --抄见水量
		     t.rlentrustbatch = null, --托收代扣批号
		     t.rlentrustseqno = null, -- 托收代扣流水号
		     t.rlsl    = 0 - t.rlsl, --取负              应收水量
		     t.rlje    = 0 - t.rlje, --取负              应收金额
		     t.rladdsl = 0 - t.rladdsl, --取负              加调水量
		     t.rlcolumn9  = t.rlid, --原记录.rlid       原应收帐流水
		     t.rlcolumn11 = t.rltrans, --原记录.rltrans    原应收帐事务
		     t.rlcolumn10 = t.rlmonth, --原记录.rlmonth    原应收帐月份
		     t.rlcolumn5  = t.rldate, --原记录.rldate     原帐务日期
		     t.rlscrrltrans  = t.rltrans, --原记录.rltrans    原应收帐事务
		     t.rlscrrlmonth  = t.rlmonth, --原记录.rlmonth    原应收帐月份*/
		     t.rlpaidje = 0 - t.rlpaidje, --取负              销帐金额
		     t.rlpaidper  = pm.pper, --同实收            销帐人员
		     t.rlpaiddate = pm.pdate, --同实收            销帐日期
		     t.rlznj      = 0 - t.rlznj, --取负              违约金
		     t.rldatetime = sysdate, --sysdate           发生日期
		     t.rlpid         = pm.pid, --对应的负实收流水  实收流水（与payment.pid对应）
		     t.rlpbatch      = pm.pbatch, --对应的负实收流水  缴费交易批次（与payment.pbatch对应）
		     t.rlsavingqc    = v_rl.rlsavingqc, --计算              期初预存（销帐时产生）
		     t.rlsavingbq    = 0 - t.rlsavingbq, --计算              本期预存发生（销帐时产生）
		     t.rlsavingqm    = v_rl.rlsavingqm, --计算              期末预存（销帐时产生）
		     t.rlreverseflag = 'y', --y                   冲正标志（n为正常，y为冲正）
		     t.rlilid        = null, --发票流水号
		     t.rlmisaving    = 0, --算费时预存
		     t.rlpriorje     = 0, --算费之前欠费
		     t.rlsxf         = 0 - t.rlsxf,
		     t.rlpaidmonth   = tools.fgetrecmonth(t.rlmsmfid) --2014/06/01 郑仕华 新增负记录的销账月份为当前帐务月份
		where t.rlid = v_rl.rlid;

	function f_pos_1meter(p_position in payment.pposition%type, --缴费机构
			p_oper     in payment.pper%type, --收款员
			p_rlids    in varchar2, --应收流水串
			p_rlje     in number, --应收总金额
			p_znj      in number, --销帐违约金
			p_sxf      in number, --手续费
			p_payje    in number, --实际收款
			p_trans    in payment.ptrans%type, --缴费事务
			p_miid     in payment.pmid%type, --水表资料号
			p_fkfs     in payment.ppayway%type, --付款方式
			p_paypoint in payment.ppaypoint%type, --缴费地点
			p_paybatch in payment.pbatch%type, --销帐批次
			p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			p_invno    in varchar2, --发票号
			p_commit   in varchar2, --控制是否提交（y/n）
			p_mmid     in varchar2
			) return varchar2;
		/*******************************************************************************************
		函数名：f_pos_1meter
		用途：单只水表缴费
		1、单表缴费业务，调用本函数，在payment 中记一条记录，一个id流水，一个批次
		2、多表缴费业务，通过循环调用本函数实现业务，一只水表一条记录，多个水表一个批次。
		业务规则：
		1、单只水表，非欠费全销，将待销应收id，按xxxxx,xxxxx,xxxxx| 格式存放p_rlids, 调用本过程
		2、银行行等代收机构或柜台进行单只水表的欠费全销，p_rlids='all'
		3、单缴预存，p_rlje=0
		参数：参见用途说明
		p_paybatch='999999999',则在模块内生成批次号，否则，直接使用p_paybatch作为批次号
		*******************************************************************************************/
		----step 1: 应收流水id分解，准备临时表数据-------------------------------------
			f_set_rec_tmp(p_rlids, p_miid);
		----step 10:  销帐前各项检查-------------------------------------
			select t.* into v_minfo from meterinfo t where t.miid = p_miid;
				f_chk_list(p_rlje, --应收金额
				p_znj, --销帐违约金 
				p_sxf, --手续费 
				p_payje, --实际收款 
				v_minfo.misaving --当前预存 
				);
			--取最近一次实收记录
			select max(t.pid), count(t.pid) into v_last_pid, v_nresult from payment t where t.pmid = p_miid;
			--取实收帐的预存期末值
			v_last_saving := 0;
			if v_nresult > 0 then select t.psavingqm into v_last_saving from payment t where t.pid = v_last_pid; end if;
			--如果预存期末值和水表信息的预存余额不符，则记录异常
			if v_last_saving <> v_minfo.misaving then 
			insert into chk_result values (seq_chk_list.nextval,sysdate,'预存检查','水表信息预存金额和实收帐表预存期末不符！','',p_miid,v_last_pid,'','水表预存余额:' || to_char(v_minfo.misaving) || '  实收帐预存期末:' ||to_char(v_last_saving),'');
		----step 20: 参数准备，为调用核心销帐过程准备参数------------------------------------------------
			v_paybatch := (case when p_paybatch <> '9999999999' then p_paybatch else fgetsequence('entrustlog') end);
		----step 30: 调用核心销帐过程销帐-----------------------------------------------------
			f_pay_core(p_position, --缴费机构
				p_oper, --收款员
				p_miid, --水表编号
				p_rlje, --应收金额
				p_znj, --销帐违约金
				p_sxf, --手续费
				p_payje, --实际收款
				p_trans, --缴费事务
				p_fkfs, --付款方式
				p_paypoint, --缴费地点
				v_paybatch, --缴费事务流水
				p_ifp, --是否打票  y 打票，n不打票， r 应收票
				p_invno, --发票号
				v_payid --实收流水，返回此次记账的实收流水号
				);
		----step 40: 事务提交：根据参数判断是否提交---------------------------------------------------------

	function f_pos_1meter_zfb(p_position in payment.pposition%type, --缴费机构
			p_oper     in payment.pper%type, --收款员
			p_rlids    in varchar2, --应收流水串
			p_rlje     in number, --应收总金额
			p_znj      in number, --销帐违约金
			p_sxf      in number, --手续费
			p_payje    in number, --实际收款
			p_trans    in payment.ptrans%type, --缴费事务
			p_miid     in payment.pmid%type, --水表资料号
			p_fkfs     in payment.ppayway%type, --付款方式
			p_paypoint in payment.ppaypoint%type, --缴费地点
			p_paybatch in payment.pbatch%type, --销帐批次
			p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			p_invno    in varchar2, --发票号
			p_commit   in varchar2, --控制是否提交（y/n）
			p_pbseqno  in varchar2,  --支付宝流水
			p_mmid     in varchar2
			) return varchar2;
		逻辑与f_pos_1meter 相同

	function f_pos_1meter_wx(p_position in payment.pposition%type, --缴费机构
			p_oper     in payment.pper%type, --收款员
			p_rlids    in varchar2, --应收流水串
			p_rlje     in number, --应收总金额
			p_znj      in number, --销帐违约金
			p_sxf      in number, --手续费
			p_payje    in number, --实际收款
			p_trans    in payment.ptrans%type, --缴费事务
			p_miid     in payment.pmid%type, --水表资料号
			p_fkfs     in payment.ppayway%type, --付款方式
			p_paypoint in payment.ppaypoint%type, --缴费地点
			p_paybatch in payment.pbatch%type, --销帐批次
			p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			p_invno    in varchar2, --发票号
			p_commit   in varchar2, --控制是否提交（y/n）
			p_pbseqno  in varchar2,  --交易流水
			p_mmid     in varchar2,
			p_pwseqno  in varchar2,--微信流水
			p_date     in varchar2  --交易申请时间
			) return varchar2;
		逻辑与f_pos_1meter 相同

	function f_pos_mult_m(p_position in payment.pposition%type, --缴费机构
			p_oper     in payment.pper%type, --收款员
			p_payje    in number, --总实际收款金额
			p_trans    in payment.ptrans%type, --缴费事务
			p_fkfs     in payment.ppayway%type, --付款方式
			p_paypoint in payment.ppaypoint%type, --缴费地点
			p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			p_invno    in varchar2, --发票号
			p_batch    in varchar2) return varchar2;
		/*******************************************************************************************
		函数名：f_pos_mult_m
		用途：
		多表缴费，通过循环调用单表缴费过程实现。
		业务规则：
		1、多只水表销帐，支持水表挑选销帐月份
		2、每只水表都不发生预存变化，收费金额=欠费金额
		参数：
		前置条件：
		1、最重要的销帐参数（水表id，应收帐流水id串，应收金额，违约金，手续费） 在调用本过程前，
		存放在临时接口表 pay_para_tmp
		2、应收帐流水串的格式见核心单表销帐过程的说明。
		*******************************************************************************************/
		select * from pay_para_tmp
		--计算单只水表的实际收款金额
		v_paid_meter := v_pp.rlje + v_pp.rlznj + v_pp.rlsxf;
		v_total := v_total + v_paid_meter;
		---单表销帐---------------------------------------------------------------------------------
		f_pos_1meter(p_position, --缴费机构
			p_oper, --收款员
			v_pp.plids, --应收流水串
			v_pp.rlje, --应收总金额
			v_pp.rlznj, --销帐违约金
			v_pp.rlsxf, --手续费
			v_paid_meter, -- 水表实际收款
			p_trans, --缴费事务
			v_pp.mid, --水表资料号
			p_fkfs, --付款方式
			p_paypoint, --缴费地点
			v_batch, --自动生成销帐批次
			p_ifp, --是否打票  y 打票，n不打票， r 应收票
			p_invno, --发票号
			'n',
			v_pp.mid);

	function f_pos_mult_hs(p_position in payment.pposition%type, --缴费机构
			 p_oper     in payment.pper%type, --收款员
			 p_mmid     in meterinfo.mipriid%type, --合收主表号
			 p_payje    in number, --总实际收款金额
			 p_trans    in payment.ptrans%type, --缴费事务
			 p_fkfs     in payment.ppayway%type, --付款方式
			 p_paypoint in payment.ppaypoint%type, --缴费地点
			 p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			 p_invno    in varchar2, --发票号
			 p_batch    in varchar2) return varchar2;
		/*******************************************************************************************
		函数名：f_pos_mult_hs
		用途：
		合收表缴费，通过循环调用单表缴费过程实现。
		业务规则：
		1、多只水表销帐，每只水表都根据客户端选择的结果返回待销流水id
		2、主表先销帐，所有销帐金额计算到主表期末余额上
		3、逐笔处理子表，主表预存转子表预存，子表预存销帐，
		4、整体事务提交
		参数：
		前置条件：
		水表和水表对应的应收帐流水串，存放在临时接口表 pay_para_tmp 中
		*******************************************************************************************/
		用到的表
		pay_para_tmp
		meterinfo
		---step 0: 将非合收主表的预存转到主表上去---------------------------------------------------
		f_remaind_trans1(mi.miid, --转出水表号
			p_mmid, --转入水表资料号
			mi.misaving, --转移金额=该水表销帐金额
			v_batch, --实收批次号
			p_position,
			p_oper,
			p_paypoint,
			'n',
			p_mmid);
		---step 1: 合收主表销帐---------------------------------------------------

		pay_para_tmp.plids is null then
		f_pos_1meter(p_position, --缴费机构
			p_oper, --收款员
			v_pp.plids, --应收流水串
			v_pp.rlje, --应收总金额
			v_pp.rlznj, --销帐违约金
			v_pp.rlsxf, --手续费
			p_payje, -- 水表实际收款
			p_trans, --缴费事务
			v_pp.mid, --水表资料号
			p_fkfs, --付款方式
			p_paypoint, --缴费地点
			v_batch,
			p_ifp, --是否打票  y 打票，n不打票， r 应收票
			p_invno, --发票号
			'n',
			p_mmid);
		else
		----记转入预存的实收帐-----------------------------------------------------------------
		f_pay_core(p_position, --缴费机构
			p_oper, --收款员
			p_mmid, --水表资料号
			0, --应收金额
			0, --销帐违约金
			0, --手续费
			p_payje, --实际收款
			'p', -- by 20150420 ralph 子表将钱转移到主表上
			p_fkfs, --付款方式
			p_paypoint, --缴费地点
			p_batch, --缴费事务批号
			'n', --是否打票  y 打票，n不打票， r 应收票
			'', --发票号
			v_payid --实收流水，返回此次记账的实收流水号
			);
		--销账记录合收主表号
		update payment set ppriid=p_mmid where pid=v_payid;
		---step 20: 合收子表销帐---------------------------------------------------
		      --计算单只水表的实际收款金额
		      v_paid_meter := 0;
		      v_total      := v_pp.rlje + v_pp.rlsxf + v_pp.rlznj;
		---step 21: 预存调拨---------------------------------------------------
		f_remaind_trans1(p_mmid, --转出水表号
			v_pp.mid, --转入水表资料号
			v_total, --转移金额=该水表销帐金额
			v_batch, --实收批次号
			p_position,
			p_oper,
			p_paypoint,
			'n',
			p_mmid);
		---step 22: 子表销帐---------------------------------------------------
		f_pos_1meter(p_position, --缴费机构
			p_oper, --收款员
			v_pp.plids, --应收流水串
			v_pp.rlje, --应收总金额
			v_pp.rlznj, --销帐违约金
			v_pp.rlsxf, --手续费
			v_paid_meter, -- 水表实际收款
			'u', -- by 20150420 ralph 子表将钱转移到主表上
			--  p_trans, --缴费事务
			v_pp.mid, --水表资料号
			p_fkfs, --付款方式
			p_paypoint, --缴费地点
			v_batch,
			p_ifp, --是否打票  y 打票，n不打票， r 应收票
			p_invno, --发票号
			'n',
			p_mmid);

	function f_pos_mult_hs_zfb(p_position in payment.pposition%type, --缴费机构
			 p_oper     in payment.pper%type, --收款员
			 p_mmid     in meterinfo.mipriid%type, --合收主表号
			 p_payje    in number, --总实际收款金额
			 p_trans    in payment.ptrans%type, --缴费事务
			 p_fkfs     in payment.ppayway%type, --付款方式
			 p_paypoint in payment.ppaypoint%type, --缴费地点
			 p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			 p_invno    in varchar2, --发票号
			 p_pbseqno  in varchar2, --支付宝流水
			 p_batch    in varchar2) return varchar2;
		逻辑与f_pos_mult_hs相同

	function f_pos_mult_hs_wx(p_position in payment.pposition%type, --缴费机构
			 p_oper     in payment.pper%type, --收款员
			 p_mmid     in meterinfo.mipriid%type, --合收主表号
			 p_payje    in number, --总实际收款金额
			 p_trans    in payment.ptrans%type, --缴费事务
			 p_fkfs     in payment.ppayway%type, --付款方式
			 p_paypoint in payment.ppaypoint%type, --缴费地点
			 p_ifp      in varchar2, --是否打票  y 打票，n不打票， r 应收票
			 p_invno    in varchar2, --发票号
			 p_pbseqno  in varchar2, --交易流水
			 p_batch    in varchar2,
			 p_pwseqno  in varchar2,--微信流水
			 p_date     in varchar2  --交易申请时间
			) return varchar2;
		逻辑与f_pos_mult_hs相同

	function f_remaind_trans1(p_mid_s    in meterinfo.miid%type, --转出水表号
			    p_mid_t    in meterinfo.miid%type, --水表资料号
			    p_je       in meterinfo.misaving%type, --转移金额
			    p_batch    in payment.pbatch%type, --实收帐批次号
			    p_position in payment.pposition%type,
			    p_oper     in payment.ppayee%type,
			    p_paypoint in payment.ppaypoint%type,
			    p_commit   in varchar2, --是否提交
			    p_mmid     in varchar2
			    ) return varchar2;
		/*******************************************************************************************
		函数名：f_remaind_trans
		用途：在2块水表之间进行预存转移
		参数： 转出水表号，准入水表号，金额
		业务规则：
		1、调用核心销帐过程，水费金额=0时为单缴预存，
		2、在payment中，增加2条记录，一个为正预存，一个为负预存
		3、2条记录同一个批次号
		返回值：成功--0，失败---非零
		*******************************************************************************************/
		--如果源水表预存小于转出金额，抛出错误
		if mi.misaving < p_je then raise err_je; end if;
		f_pay_core(p_position, --缴费机构
			p_oper, --收款员
			p_mid_s, --水表资料号
			0, --应收金额
			0, --销帐违约金
			0, --手续费
			-1 * p_je, --实际收款
			paytrans_ycdb, --缴费事务
			'xj', --付款方式
			p_paypoint, --缴费地点
			p_batch, --缴费事务批号
			'n', --是否打票  y 打票，n不打票， r 应收票
			'', --发票号
			v_payid --实收流水，返回此次记账的实收流水号
		);
		update payment set ppriid=p_mmid where pid=v_payid;
		f_pay_core(p_position, --缴费机构
			p_oper, --收款员
			p_mid_t, --水表资料号
			0, --应收金额
			0, --销帐违约金
			0, --手续费
			p_je, --实际收款
			paytrans_ycdb, --缴费事务
			'xj', --付款方式
			p_paypoint, --缴费地点
			p_batch, --缴费事务批号
			'n', --是否打票  y 打票，n不打票， r 应收票
			'', --发票号
			v_payid --实收流水，返回此次记账的实收流水号
			);
		update payment set ppriid=p_mmid where pid=v_payid;

	procedure sp_auto_pay(p_miid in meterinfo.miid%type);
		/*******************************************************************************************
		函数名：sp_auto_pay
		用途：普通水表自动预存抵扣缴费
		参数：  --水表号
		*******************************************************************************************/
		f_pos_1meter(pm.pposition, --缴费机构
                              pm.pper, --收款员
                              'all', --应收流水串，全部销帐
                              pm.pspje, --应收总金额
                              pm.pznj, --销帐违约金
                              pm.psxf, --手续费
                              pm.ppayment, --实际收款
                              pm.ptrans, --缴费事务
                              pm.pmid, --水表资料号
                              pm.ppayway, --付款方式
                              pm.ppaypoint, --缴费地点
                              pm.pbatch, --销帐批次
                              'n', --是否打票  y 打票，n不打票， r 应收票
                              '',
                              'y',
                              pm.pmid);

	procedure sp_auto_pay_1rec(p_rec in reclist%rowtype);
		/*******************************************************************************************
		函数名：sp_auto_pay_1rec
		用途：
		普通水表1条应收记录自动预存抵扣缴费
		业务规则：

		参数：  --应收流水id
		前置条件：
		*******************************************************************************************/
		f_pos_1meter(pm.pposition, --缴费机构
                              pm.pper, --收款员
                              'all', --应收流水串，全部销帐
                              pm.pspje, --应收总金额
                              pm.pznj, --销帐违约金
                              pm.psxf, --手续费
                              pm.ppayment, --实际收款
                              pm.ptrans, --缴费事务
                              pm.pmid, --水表资料号
                              pm.ppayway, --付款方式
                              pm.ppaypoint, --缴费地点
                              pm.pbatch, --销帐批次
                              'n', --是否打票  y 打票，n不打票， r 应收票
                              '',
                              'y',
                              pm.pmid);

	function f_payback_by_pmid(p_payid    in payment.pid%type,
			     p_position in payment.pposition%type,
			     p_oper     in payment.pper%type,
			     p_batch    in payment.pbatch%type,
			     p_paypoint in payment.ppaypoint%type,
			     p_trans    in payment.ptrans%type,
			     p_commit   in varchar2) return varchar2;
		/*******************************************************************************************
		函数名：f_payback_by_pmid
		用途：实收冲正,按实收流水id冲正
		*******************************************************************************************/
		--step 1:实收帐处理----------------------------------
		--检查是否有符合条件的待冲正记录
		select * from payment t where t.pid = p_payid and t.preverseflag <> 'y';
		--支票档处理,冲正时需写入一笔资负帐入支票档cheque
		select * into cq from  cheque   where chequeid=pm.pbatch;
		cq.chequemoney:= 0 - pm.ppayment;
		cq.chequecrflag:='y';
		cq.chequememo:='实收冲正写入'; --add 20140905
		delete from cheque  where chequeid=cq.chequeid ;
		insert into cheque values cq;
		--准备实收冲正负记录的数据
		pm.pposition    := p_position; --参数
		if pm.ptrans ='u' and upper(pm.pper) ='system' then pm.pper:= 'system'; else pm.pper:= p_oper; end if ;
		pm.psavingqc    := mi.misaving; --取当前
		pm.psavingbq    := 0 - pm.psavingbq; --取负
		pm.psavingqm    := mi.misaving + pm.psavingbq; --计算
		pm.ppayment     := 0 - pm.ppayment; --取负
		pm.pbatch       := p_batch; --参数
		if pm.ptrans ='u' and upper(pm.pper) ='system' then pm.ppayee:= 'system'; else pm.ppayee:= p_oper; end if ;
		pm.pchkdate     :=sysdate ; --这里需要将扎帐日期记录为当前的系统操作日期 by 20150203 ralph
		pm.ppaypoint    := p_paypoint; --参数
		pm.psxf         := 0 - pm.psxf; --取负
		pm.pilid        := ''; --无
		pm.pznj         := 0 - pm.pznj; --取负
		pm.prcreceived  := 0 - pm.prcreceived; --取负
		pm.pspje        := 0 - pm.pspje; --取负
		pm.preverseflag := 'y'; --y
		pm.pscrid       := pm.pid; --原记录.pid
		pm.pscrtrans    := pm.ptrans; --原记录.ptrans
		pm.pscrmonth    := pm.pmonth; --原记录.pmonth
		pm.pscrdate     := pm.pdate; --原记录.pdate
		pm.pid   := fgetsequence('payment'); --新生成
		pm.pdate := tools.fgetpaydate(mi.mismfid); --sysdate
		pm.pid       := fgetsequence('payment'); --新生成
		pm.pdate     := tools.fgetpaydate(mi.mismfid); --sysdate
		pm.pdatetime := sysdate; --sysdate
		pm.pmonth    := tools.fgetrecmonth(mi.mismfid); --当前月份
		pm.pchkno := null ;-- 20140806营销单号写入为空，以免造成对账误解
		pm.tchkdate :=null;-- 20140806营销单号写入为空，以免造成对账误解
		pm.pdzdate :=null;-- 20140806营销单号写入为空，以免造成对账误解
		--插入冲正实收负记录
		insert into payment t values pm;
		--原被冲正记录打上冲正标志
		update payment t set t.preverseflag = 'y' where t.pid = p_payid;
		-----step 10: 增加负应收记录
		insert into reclist_1meter_tmp t select s.* from reclist s where s.rlpid = p_payid and s.rlpaidflag = 'y';
		-----step 11: 保存需要冲正处理的应收明细帐记录
		insert into recdetail_tmp t (select a.* from recdetail a, reclist_1meter_tmp b where a.rdid = b.rlid);
		-----step 12: 在应收总账临时表中做负记录的调整
		f_set_cr_reclist(pm)
		-----step 13: 将应收冲正负记录插入到应收总账中
		    insert into reclist t (select s.* from reclist_1meter_tmp s);
		-----step 14: 在应收明细临时表中做负记录的调整
		--一般字段调整
		update recdetail_tmp t
		set t.rdyssl  = 0 - t.rdyssl,
		t.rdysje  = 0 - t.rdysje,
		t.rdsl    = 0 - t.rdsl,
		t.rdje    = 0 - t.rdje,
		t.rdadjsl = 0 - t.rdadjsl,
		t.rdadjje = 0 - t.rdadjje,
		t.rdznj   = 0 - t.rdznj;
		--流水id调整
		update recdetail_tmp t set t.rdid = (select s.rlid from reclist_1meter_tmp s where t.rdid = s.rlcolumn9) where t.rdid in (select rlcolumn9 from reclist_1meter_tmp);
		--插入到应收明细表
		-----step 20: 保存需要冲正处理的应收总账记录
		insert into reclist_1meter_tmp t select s.* from reclist s where s.rlpid = p_payid and s.rlpaidflag = 'y';insert into recdetail t (select s.* from recdetail_tmp s);
		-----step 21: 保存需要冲正处理的应收明细帐记录
		insert into recdetail_tmp t(select a.* from recdetail a, reclist_1meter_tmp b where a.rdid = b.rlid);
		-----step 22: 在应收总账临时表中做正记录的调整
		update reclist_1meter_tmp t
		set t.rlid    = fgetsequence('reclist'), --新生成
		t.rlmonth = tools.fgetrecmonth(mi.mismfid), --当前              帐务月份
		t.rldate  = tools.fgetrecdate(mi.mismfid), --当前              帐务日期
		t.rldate        = pm.pdate, --当前*/
		t.rlcolumn5  = t.rldate, --上次应帐帐日期
		t.rlcolumn9  = t.rlid, --上次应收帐流水
		t.rlcolumn10 = t.rlmonth, --上次应收帐月份
		t.rlcolumn11 = t.rltrans, --上次应收帐事务
		t.rlscrrltrans  = t.rltrans, --原记录.rltrans
		t.rlscrrlmonth  = t.rlmonth, --原记录.rlmonth*/
		t.rlpaidflag = 'n', --n
		t.rlpaidper  = '', --无
		t.rlpaiddate = '', --无
		t.rldatetime = sysdate, --sysdate
		t.rlpid         = null, --无
		t.rlpbatch      = null, --无
		t.rlsavingqc    = 0, --无
		t.rlsavingbq    = 0, --无
		t.rlsavingqm    = 0, --无
		t.rlreverseflag = 'n',
		t.rlpaidje      = 0,
		t.rlsxf         = 0, --手续费
		t.rlznj         = 0; --违约金
		-----step 23: 将应收冲正正记录插入到应收总账中
		insert into reclist t (select s.* from reclist_1meter_tmp s);
		-----step 24: 在应收明细临时表中做正记录的调整
		update recdetail_tmp t
		set (t.rdid,
		t.rdpaidflag,
		t.rdpaiddate,
		t.rdpaidmonth,
		t.rdpaidper,
		t.rdmonth,
		t.rdznj) =(select s.rlid, 'n', null, null, null, s.rlmonth, 0 from reclist_1meter_tmp s where t.rdid = s.rlcolumn9)
		where t.rdid in (select rlcolumn9 from reclist_1meter_tmp);
		--插入到应收明细表
		insert into recdetail t (select s.* from recdetail_tmp s);
		----step 30 原应收记录打冲正标记
		update reclist t set t.rlreverseflag = 'y' where t.rlpid = p_payid and t.rlpaidflag = 'y';
		----step 40 水表资料预存余额调整--------------------------------------------------------------
		update meterinfo t set t.misaving = pm.psavingqm, t.mipaymentid = p_payid where t.miid = pm.pmid;


	function f_payback_by_bankno(p_bseqno   in payment.pbseqno%type,
			       p_position in payment.pposition%type,
			       p_oper     in payment.pper%type,
			       p_batch    in payment.pbatch%type,
			       p_paypoint in payment.ppaypoint%type,
			       p_trans    in payment.ptrans%type)
		return varchar2;
		/*******************************************************************************************
		函数名：f_payback_bankseqno
		用途：实收冲正,按银行流水id冲正
		*******************************************************************************************/
		调用f_payback_by_pmid(pm.pid,p_position,p_oper,p_batch,p_paypoint,p_trans,'y');

	function f_payback_by_batch(p_batch    in payment.pbatch%type,
			      p_position in payment.pposition%type,
			      p_oper     in payment.pper%type,
			      p_paypoint in payment.ppaypoint%type,
			      p_trans    in payment.ptrans%type)
		return varchar2;
		/*******************************************************************************************
		函数名：f_payback_batch
		用途：实收冲正,按批次冲正
		*******************************************************************************************/
		f_payback_by_pmid(pm.pid,
			p_position,
			p_oper,
			v_batch,
			p_paypoint,
			p_trans,
			'n');
		--检查支票、抹帐、倒存
		if pm.ppayway in ('zp','mz','dc') then update cheque set chequecrflag='y',chequecrdate=sysdate,chequecroper=p_oper where chequeid=p_batch;end if;
		update kpi_task t set t.do_date = sysdate, t.isfinish = 'y' where t.report_id = trim(p_batch);
		--红冲电子发票
		p_sp_cancel(p_batch,'pbatch',p_oper);

	procedure p_sp_cancel(p_batch in varchar2,p_lx in varchar2,p_per varchar2);
		--1、查询原账务是否开票
		select max(isp.isbcno),max(isp.isno) into v_isbcno,v_isno from inv_einvoice_st ie, inv_info_sp ii,invstock_sp isp where ...;
		--2、已开票情况作废发票
		if v_isbcno is not null and v_isno is not null then
			pg_ewide_einvoice.p_cancel_hrb(v_isbcno,v_isno,pm.pid,o_code,o_errmsg);
			if o_code = '0000' then pg_ewide_invmanage_sp.sp_invmang_modifystatus('p',v_isno,v_isno,v_isbcno,p_per,2,'实收冲正发票作废',o_errmsg); end if;
		end if;
end;

create or replace package pg_ewide_job_hrb2 as
	--哈尔滨维护后台工作包
	--自定义错误代码
	error_customerpwd_length constant integer := -2; 
	type myref is ref cursor;

	function f_getcustomerpwd(ic_micid   in    varchar2) return varchar2; 
		--函数名称 : f_getcustomerpwd
		--用途: 根据用户编号返回用户的水表加密密码(已转换小写)
		--参数：ic_micid  in varchar2  用户编号
		--返回值: 加密的用户口令(32位,小写),如果有任何异常,返回null
		--创建日期: 2015/12/8
		select miyl4 into c_encryptPwd from meterinfo where micid = ic_micid;

	procedure prc_chgcustomerpwd( ic_micid      in   varchar2,
			ic_plainpwd   in   varchar2,
			on_appcode    out  number,
			oc_error      out  varchar2); 
		--过程名称 : prc_chgcustomerpwd
		--创建日期: 2015/12/8
		--用途: 修改客户的水表密码
		--参数：ic_micid    in  varchar2  用户编号
		--      ic_plainpwd in  varchar2  用户明文密码
		--      on_appcode  out number    返回码（成功执行返回 1,密码位数错误返回 -2 ,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）     
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		update meterinfo set MIYL4 = md5(ic_plainpwd) where micid = ic_micid; 

	function f_getaccountprecash(ic_micid   in    varchar2) return number; 
		--函数名称 : f_getaccountprecash
		--用途: 根据编号返回账户的预存余额(如果是合收表,返回合收账户金额)
		--参数：ic_micid  in varchar2  用户编号
		--返回值: 预存余额
		select sum(nvl(misaving,0)) into n_cash from meterinfo mi where mipriid = (select mipriid from meterinfo where micid = ic_micid);

	procedure prc_metercancellation( ic_micid      in   varchar2,
			   ic_trans      in   varchar2,
			   ic_oper       in   varchar2,
			   on_appcode    out  number,
			   oc_error      out  varchar2);
		--过程名称 : prc_metercancellation
		--创建日期: 2016/3/14
		--用途: 撤表销户(单块水表) 简单的销户操作 不考虑财务
		--参数：ic_micid    in  varchar2  用户编号
		--      ic_trans    in  varchar2  销户事务类型
		--      ic_oper     in  varchar2  操作员
		--      on_appcode  out number    返回码（成功执行返回 1,密码位数错误返回 -2 ,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）     
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		--1.更新meterinfo主表状态 
		--mistatus='7',--销户状态
		update meterinfo set mistatus = '7',mistatusdate = sysdate, mistatustrans = ic_trans, miuninsdate = sysdate where micid = ic_micid;
		--2.销户后同步用户状态
		update custinfo set cistatus = '7', cistatusdate = sysdate, cistatustrans = ic_trans where cicode = ic_micid; 
		--3. 去掉低度  ??? 
		update priceadjustlist pl set pl.palstatus = 'n' where pl.palmid = ic_micid;
		--4.同步更新水表档案 
		update meterdoc set mdstatus = '7', mdstatusdate = sysdate where mdmid = ic_micid; 
		--5.作废水表 
		--status = '6' 表身码作废
		update st_meterinfo_store set status = '6', miid = ic_micid, statusdate = sysdate where bsm = (select mdno from meterdoc where mdmid = ic_micid );  
		--6.作废封号 
		--fhstatus = '4' 封号状态作废；fhtype '1' 塑封号,'2' 刚封号,'4' 铅封号,'3' 稽查封号
		update st_meterfh_store set fhstatus = '4',mainman = ic_oper,maindate = sysdate 
		where (storeid,meterfh,fhtype,caliber) in 
		(select mismfid, dqsfh,'1', mdcaliber from meterinfo mi, meterdoc md where mi.micid = ic_micid and mi.micid = md.mdmid );
		...
		(select mismfid, dqsfh,'2', mdcaliber from meterinfo mi, meterdoc md where mi.micid = ic_micid and mi.micid = md.mdmid );
		...
		(select mismfid, dqsfh,'3', mdcaliber from meterinfo mi, meterdoc md where mi.micid = ic_micid and mi.micid = md.mdmid );
		...
		(select mismfid, dqsfh,'4', mdcaliber from meterinfo mi, meterdoc md where mi.micid = ic_micid and mi.micid = md.mdmid );

	function f_checkunfinishedbill(ic_micid   in    varchar2) return varchar2; 
		--函数名称 : f_checkunfinishedbill
		--用途: 根据编号返回用户未完结的工单号
		--参数：ic_micid  in varchar2  用户编号
		--返回值: 以'|'返回的工单号
		--创建日期: 2016/3/17
		--表务工单
		select mthno billno from metertranshd hd1,metertransdt dt1
		where hd1.mthno = dt1.mtdno and dt1.mtdmid in (select miid from meterinfo mi where mipriid = c_priid ) and hd1.MTHSHFLAG = 'N'
		--用户变更单
		select CCHNO billno from CUSTCHANGEHD hd2,CUSTCHANGEDT dt2 
		where hd2.cchno = dt2.ccdno and dt2.miid in (select miid from meterinfo mi where mipriid = c_priid ) and hd2.CCHSHFLAG = 'N'
		--应收计费单
		select rthno billno from RECTRANSHD hd3 
		where hd3.rthmid in (select miid from meterinfo mi where mipriid = c_priid ) and RTHSHFLAG = 'N' 
		--应收调整单
		select rahno billno from RECADJUSTHD hd4,RECADJUSTDT dt4
		where hd4.rahno = dt4.radno and dt4.RADMID in (select miid from meterinfo mi where mipriid = c_priid ) and hd4.RAHSHFLAG = 'N'
		--特殊水价收费单
		select crhno billno from TDSJHD hd5 
		where hd5.miid in (select miid from meterinfo mi where mipriid = c_priid ) and hd5.CRHSHFLAG = 'N' 
		--实收冲正单
		select PAHNO billno from PAIDADJUSTHD hd6
		where HD6.PAHMID in (select miid from meterinfo mi where mipriid = c_priid ) and hd6.PAHSHFLAG = 'N'
		--应收调整单
		select rchno billno from recczhd hd7,recczdt dt7
		where hd7.rchno = dt7.rcdno and dt7.rcdmid in (select miid from meterinfo mi where mipriid = c_priid ) and hd7.rchshflag = 'N'

	function f_getcbtftotal(ic_smfid in varchar2,ic_month in varchar2) return number; 
		--函数名称 : f_getcbtftotal
		--用途: 返回指定营业所指定账务月份撤表退费金额(审核后的)
		--参数：ic_smfid  in varchar2  营业所编号
		--      ic_month  in varchar2  账务月份 (yyyy.mm)
		--返回值: 撤表退费金额
		--创建日期: 2016/3/30
		select abs(sum(ycmisaving)) from meterinfo_yccz where ycmfid = decode(ic_smfid,null,ycmfid,ic_smfid) and ycmonth = decode(ic_month,null,ycmonth,ic_month) and yctype = '2';

	function f_getyctftotal(ic_smfid in varchar2,ic_month in varchar2) return number; 
		--函数名称 : f_getyctftotal
		--用途: 返回指定营业所指定账务月份预存退费金额(审核后的)
		--参数：ic_smfid  in varchar2  营业所编号
		--      ic_month  in varchar2  账务月份 (yyyy.mm)
		--返回值: 撤表退费金额
		--创建日期: 2016/3/30
		select abs(sum(ycmisaving)) from meterinfo_yccz where ycmfid = decode(ic_smfid,null,ycmfid,ic_smfid) and ycmonth = decode(ic_month,null,ycmonth,ic_month) and yctype = '1';

	function f_getallotmoney(ic_rlid   in    varchar2) return number;
		--函数名称:f_getallotmoney
		--用途:获取基建临时用水已调拨预存金额
		--参数 ic_rlid   in   varchar2  应收流水号
		--返回值:对应指定应收流水号，已经调拨的预存金额
		select sum(baallotsum) from baseallot ba where ba.barlid = ic_rlid and ba.bastatus = 'y';

	function f_getallotmoney(ic_smfid in varchar2,ic_month in varchar2) return number;
		--函数名称:f_getallotmoney
		--用途:获取基建临时用水已调拨预存金额(汇总)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month   in   varchar2  账务月份
		--返回值:统计指定分公司指定账务业务 已经调拨的预存金额
		if ic_month >= '2016.05' then
			select sum(baAllotsum) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and ba.bamonth = ic_month and ba.bastatus = 'Y' ;
		else
			select sum(nvl(RD.CHARGE1,0))  from reclist rl, payment p, VIEW_RECLIST_CHARGE RD where rl.rlpid = p.pid and  rlid= rdid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and ( rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null' );   
		
	function f_getallotmoney(ic_smfid in varchar2,ic_month1 in varchar2,ic_month2 in varchar2) return number;
		--函数名称:f_getallotmoney
		--用途:获取基建临时用水已调拨预存金额(汇总)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month1  in   varchar2  账务月份-起始
		--     ic_month2  in   varchar2  账务月份-终止 
		--返回值:统计指定分公司指定账务业务 已经调拨的预存金额
		if ic_month >= '2016.05' then
			select sum(baAllotsum) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and ba.bamonth = ic_month and ba.bastatus = 'Y' ;
		else
			select sum(nvl(RD.CHARGE1,0))  from reclist rl, payment p, VIEW_RECLIST_CHARGE RD where rl.rlpid = p.pid and  rlid= rdid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and ( rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null' );   
		 n_allotMoney := n_allotMoney + nvl(n_temp,0);		

	function f_getallotsl(ic_rlid in varchar2) return number;
		--函数名称:f_getallotsl
		--用途:获取基建临时用水已调拨水量
		--参数 ic_rlid   in   varchar2  应收流水号
		--返回值:对应指定应收流水号，已经调拨的水量
		if n_month >='2016.05' then
			select sum(BAALLOTSL) from Baseallot ba where ba.barlid = ic_rlid and ba.bastatus = 'Y';
		else
			select sum(nvl(rlsl,0))  from reclist rl, payment p where rl.rlpid = p.pid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = n_month;  
               
	function f_getallotsl(ic_smfid in varchar2, ic_month in varchar2) return number;
		--函数名称:f_getallotsl
		--用途:获取基建临时用水已调拨水量(汇总)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month   in   varchar2  账务月份
		--返回值:统计指定分公司指定账务业务 已经调拨的预存金额
		if ic_month >= '2016.05' then
			select sum(ba.baallotsl) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and ba.bamonth = ic_month and ba.bastatus = 'Y' ;
		else
			select sum(nvl(rlsl,0)) from reclist rl,payment p where rl.rlpid = p.pid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and (rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null');   

	function f_getallotsl(ic_smfid in varchar2, ic_month1 in varchar2,ic_month2 in varchar2) return number;
		--函数名称:f_getallotsl
		--用途:获取基建临时用水已调拨水量(汇总)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month1  in   varchar2  账务月份-起始
		--     ic_month2  in   varchar2  账务月份-终止 
		--返回值:统计指定分公司指定账务业务 已经调拨的水量
		if ic_month >= '2016.05' then
			select sum(ba.baallotsl) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and  ba.bamonth = ic_month and ba.bastatus = 'Y' ;
		else
			select sum(nvl(rlsl,0))  from reclist rl, payment p where rl.rlpid = p.pid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and (rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null');   
		n_allotSl := n_allotSl + nvl(n_temp,0);

	function f_getallotsl_current(ic_smfid in varchar2, ic_month1 in varchar2,ic_month2 in varchar2) return number;
		--函数名称:f_getallotsl_current
		--用途:获取基建临时用水已调拨水量(回收当月)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month1  in   varchar2  账务月份-起始
		--     ic_month2  in   varchar2  账务月份-终止 
		--返回值:统计指定分公司指定账务月份 已经调拨当月的水量
		if ic_month >= '2016.05' then
			select sum(ba.baallotsl) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and  ba.bamonth = ic_month and ba.bastatus = 'Y' and 
			exists(select 1 from payment pm where ba.bapid = pm.pid and pm.pmonth = bamonth);
		else
			select sum(nvl(rlsl,0))  from reclist rl, payment p where rl.rlpid = p.pid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and (rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null') and p.pmonth = c_month;   
		n_allotSl := n_allotSl + nvl(n_temp,0);

	function f_getallotmoney_current(ic_smfid in varchar2, ic_month1 in varchar2,ic_month2 in varchar2 ) return number; 
		--函数名称:f_getallotmoney_current
		--用途:获取基建临时用水已调拨金额(回收当月)
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month1  in   varchar2  账务月份-起始
		--     ic_month2  in   varchar2  账务月份-终止 
		--返回值:统计指定分公司指定账务月份 已经调拨当月的金额
		if ic_month >= '2016.05' then
			select sum(ba.baAllotSum) from baseAllot ba where (ba.basmfid = ic_smfid or lower(ic_smfid) = 'null') and  ba.bamonth = ic_month and ba.bastatus = 'Y' and 
			exists(select 1 from payment pm where ba.bapid = pm.pid and pm.pmonth = bamonth);
		else
			select sum(nvl(rlje,0))  from reclist rl, payment p where rl.rlpid = p.pid and rl.rltrans = 'u' /*基建水费*/ and p.pmonth = ic_month and (rl.rlsmfid = ic_smfid or lower(ic_smfid) = 'null') and p.pmonth = c_month;   
		n_allotSl := n_allotSl + nvl(n_temp,0);

	function f_getallotnumber(ic_smfid in varchar2, ic_month in varchar2 ) return number;
		--函数名称:f_getallotnumber
		--用途:获取基建临时用水已调拨件数
		--参数 ic_smfid   in   varchar2  营业所
		--     ic_month   in   varchar2  账务月份-起始
		--返回值:统计指定分公司指定账务月份 已经调拨的件数
		select count(distinct ba.bacid) from baseAllot ba where (ba.basmfid = ic_smfid or ic_smfid = 'null' or ic_smfid is null) and ba.bamonth = ic_month and ba.bastatus = 'Y' ;

	procedure prc_baseallot( ic_rlid in varchar2,in_allotsl in varchar2,in_allotje in varchar2,ic_oper in varchar2,on_appcode out number,oc_error out varchar2);
		--过程名称 : prc_baseallot
		--创建日期: 2016/5/17
		--用途: 基建预存水费调拨收入
		--参数：ic_rlid     in  varchar2  应收流水号
		--      in_allotsl  in  number    调拨水量
		--      in_allotje  in  number    调拨金额
		--      ic_oper     in  varchar2  操作员
		--      on_appcode  out number    返回码（成功执行返回 1,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		--检查基建调拨开关
		if fsyspara('base') = 'n' then return;
		--检索基建应收记录
		select * into rec_reclist from reclist where rlid = ic_rlid;
		--检索基建用水立账工单记录
		select rlscrrlid into c_rlscrrlid from reclist where rlid = ic_rlid;
		select * into rec_rectranshd from rectranshd where rthrlid = c_rlscrrlid;
		--检索水费价格
		select rd.rdysdj,rd.rdpfid into n_price,n_pfid from recdetail rd where rd.rdid = ic_rlid and rdpiid = '01';
		--检验调拨水量、金额是否有效
		if f_getallotsl(ic_rlid) + in_allotsl > rec_reclist.rlsl then return;end if;
		if f_getallotmoney(ic_rlid) + in_allotje > rec_reclist.rlje then return; end if;
		--本月调拨 算入上个月收入
		c_umonth := to_char(add_months(to_date(to_char(sysdate,'yyyy.mm') || '.01','yyyy.mm.dd'),-1),'yyyy.mm');
		--插入基建预存调拨表
		insert into baseallot values ...

	procedure prc_unbaseallot(in_baid in varchar2,ic_oper in varchar2,on_appcode out number,oc_error out varchar2);
		--过程名称 : prc_unbaseallot
		--创建日期: 2016/5/17
		--用途: 取消预存水费调拨
		--参数：in_baid     in  number    调拨流水号
		--      ic_oper     in  varchar2  操作员
		--      on_appcode  out number    返回码（成功执行返回 1,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		--检查基建调拨开关
		if fsyspara('base') = 'n' then return;
		--调拨月份
		c_umonth := to_char(add_months(to_date(to_char(sysdate,'yyyy.mm') || '.01','yyyy.mm.dd'),-1),'yyyy.mm');
		if rec_baseAllot.Bamonth < c_umonth then return;end if;
		update Baseallot ba set ba.bastatus = 'N',ba.bacanceloper = ic_oper,ba.bacanceldate = sysdatewhere current of cur_baseAllot;

	procedure prc_rpt_allot_sum( ic_month in varchar2,on_appcode out number,oc_error out varchar2); 
		--过程名称 : prc_rpt_allot_sum
		--创建日期: 2016/5/29
		--用途: 基建预存调拨统计汇总
		--参数：ic_month    in  varchar   账务月份
		--      on_appcode  out number    返回码（成功执行返回 1,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		--已有预存记录
		select * from RPT_BASEALLOT_SUM rpt 
		where umonth = to_char(add_months(to_date(ic_month||'.01' ,'yyyy.mm.dd'),-1),'yyyy.mm') 
		and LAST_REMAIN_SL <> 0;--by 20190829 冲往年帐务的负记录也要算作基数
		--本月新增预存金额
		select sum(rl.rlsl) rlsl,sum(rl.rlje) rlje,max(rl.rlmonth) rlmonth,rl.rlsmfid rlsmfid,rl.rlmid rlmid from reclist rl 
		where rl.rltrans = 'u' and rl.rlpaidmonth = ic_month and rl.rlpaidflag = 'Y' /*and rl.rlreverseflag = 'N'*/ and rl.rlbadflag = 'N' 
		group by rlsmfid,rlmid order by rl.rlmid,rlmonth; 
		--本月调拨记录
		select bacid,basmfid,sum(baallotSl) baallotSl,sum(baallotSum) baallotsum from baseAllot ba
		where bamonth = ic_month and bastatus = 'Y' group by bacid,basmfid;

		if ic_month > '2016.05' then
		update rpt_baseallot_sum rpt set rpt.smfid = rec_add.rlsmfid,rpt.add_sl = rec_add.rlsl,rpt.add_money = rec_add.rlje
			if sql%rowcount = 0 then
			insert into rpt_baseallot_sum values ...

		update rpt_baseAllot_sum rpt 
		set rpt.smfid = rec_allot.basmfid,rpt.allot_sl = rec_allot.baallotSl,rpt.allot_money = rec_allot.baallotSum
		where rpt.miid = rec_allot.bacid and rpt.umonth = ic_month;

		update rpt_baseAllot_sum rpt
		set rpt.this_remain_sl = nvl(rpt.last_remain_sl,0) + nvl(rpt.add_sl,0) - nvl(rpt.allot_sl,0),
		rpt.this_remain_money = nvl(rpt.last_remain_money,0) + nvl(rpt.add_money,0) - nvl(rpt.allot_money,0)
		where rpt.umonth = ic_month;

	procedure prc_rpt_allot_init;
		--基建预存调拨统计表 初始化 只执行一次!!!
		select sum(rl.rlsl) rlsl,sum(rl.rlje) rlje,rl.rlmonth rlmonth,rl.rlsmfid rlsmfid,rl.rlmid rlmid 
		from reclist rl 
		where rl.rltrans = 'u' and rl.rlpaidflag = 'Y' and rl.rlreverseflag = 'N' and rl.rlbadflag = 'N' and rl.rlpaidmonth = c_startMonth
		group by rlsmfid,rlmid,rlmonth order by rl.rlmid,rl.rlmonth;

		truncate table RPT_BASEALLOT_SUM
		insert into rpt_baseallot_sum values ...

	procedure prc_rpt_allot_carryover( ic_month in varchar2,on_appcode out number,oc_error out varchar2);
		--过程名称: prc_rpt_allot_carryover
		--创建日期: 2016.6
		--用途: 基建预存调拨统计表月末结转
		--参数: ic_month   in   varchar2  账务月份
		--      on_appcode  out number    返回码（成功执行返回 1,其他未定义异常返回 -1 ）
		--      oc_error    out varchar2  返回错误（如有异常返回对应错误信息）
		--提交方式 ： 调用者根据返回码 提交(回滚 )
		select * from RPT_BASEALLOT_SUM rpt where umonth = ic_month and THIS_REMAIN_SL <> 0;

		update rpt_baseallot_sum 
		set last_remain_sl = rec_rpt.this_remain_sl,last_remain_money = rec_rpt.this_remain_money
		where miid = rec_rpt.miid and umonth = to_char(add_months(to_date(ic_month || '.01','yyyy.mm.dd'),1),'yyyy.mm');

			if sql%rowcount = 0 then
			insert into rpt_baseallot_sum values...

		update rpt_baseAllot_sum rpt
		set rpt.this_remain_sl = nvl(rpt.last_remain_sl,0) + nvl(rpt.add_sl,0) - nvl(rpt.allot_sl,0),
		rpt.this_remain_money = nvl(rpt.last_remain_money,0) + nvl(rpt.add_money,0) - nvl(rpt.allot_money,0)
		where rpt.umonth = to_char(add_months(to_date(ic_month || '.01','yyyy.mm.dd'),1),'yyyy.mm');

	--水费水量完成情况同期对比
	procedure prc_comparereport( ic_smfid in varchar2,  --营业所id
		       ic_umonth_beg  in   varchar2,  --比较起始账务月份
		       ic_umonth_end  in   varchar2,  --比较终止账务月份                            
		       oc_data        out  myref      --返回数据);

	--水费水量完成情况同期对比-动态
	procedure prc_comparereport2(ic_smfid in varchar2,  --营业所id
		       ic_umonth_beg  in   varchar2,  --比较起始账务月份
		       ic_umonth_end  in   varchar2,  --比较终止账务月份                            
		       oc_data        out  myref      --返回数据);
end pg_ewide_job_hrb2;

package pg_ewide_reportsum_hrb
	ls_need_reeval constant integer := 1;
	procedure 初始化中间表(a_month in varchar2);
		select pid,a_month u_month from payment where pmonth = a_month
		select rlid from reclist where rlmonth = a_month
		--水价信息
		delete price_prop;
		insert into price_prop select * from view_price_prop;

		insert into mv_reclist_charge_02 select ... from recdetail rd where rdid >= (select min(rlid) from reclist rl where rl.rlmonth = a_month ) and rdid not like 's%'  and not exists(select 1 from mv_reclist_charge_02 mv where rd.rdid = mv.rdid) 

		delete rpt_sum_pid nologging where u_month = a_month;
		insert /*+append*/ into rpt_sum_pid nologging values recps (i);

	procedure 清理数据(a_month in varchar2);
		if a_month = 'all' then
			delete rpt_sum_read;
			delete rpt_sum_detail;
			delete rpt_sum_charge;
			delete rpt_sum_remain;
			delete rpt_sum_total;
		else
			delete rpt_sum_read where u_month = a_month;
			delete rpt_sum_detail where u_month = a_month;
			delete rpt_sum_charge where u_month = a_month;
			delete rpt_sum_remain where u_month = a_month;
			delete rpt_sum_total where u_month = a_month;

	procedure 预存存档(a_month in varchar2);
		with rl_dis as(select rlmid, sum(rlje) rlje from reclist rl where rl.rlpaidflag = 'n' and rl.rlbadflag = 'n' group by rlmid)
		select l_tpdate tpdate, a_month u_month, meterno miid, misaving remain, 0 rsmeain, rlje discharge
		from mv_meter_prop m, rl_dis rl where m.meterno = rl.rlmid(+);

		insert /*+append*/ into rpt_sum_remain nologging values recs (i);

	procedure 抄表统计(a_month in varchar2);
		--1.当月报表数据
		delete rpt_sum_read t where t.u_month = a_month;
		insert into rpt_sum_read select ... from mv_meter_prop
		--2.生成总水量等应收信息  
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m
		update rpt_sum_temp t set t.t2 = '无表册' where t.t2 is null;
		update rpt_sum_temp t set t4 = '无人员' where t.t4 is null;

		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--3.生成收免信息
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl, meterinfo m, view_recdetail_01 rd
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--4.生成污水超标数据
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		---5.生成销账数据(销账为当月,应收不限)
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,payment p
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--6.增加消防水鹤的  by  20151203 ralph
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--7.销当月(销账月份为当月,应收月份也为当月)
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--8.总欠费(只统计当月月末欠费情况)
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd
		insert into rpt_sum_read select ... from rpt_sum_temp
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--9. 更新 单价、科室信息
		update rpt_sum_read set ... = (select ... from price_prop t2 where t2.watertype = t1.watertype) where u_month = a_month;
		--10. -=========指标相关(户数)=========
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... from mv_meter_prop m
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--11.=========指标相关(抄表库)=========
		truncate table rpt_sum_temp
		insert into rpt_sum_temp select ... METERREADHIS MR, MV_METER_PROP 
		update rpt_sum_read set ... select ... from rpt_sum_temp tmp
		--计算排名
		/*
		m18 is '坐收回收率';
		m19 is '走收回收率';
		m20 is '总回收率';
		m21 is '坐收排名';
		m22 is '走收排名';
		m23 is '总排名';*/
		update rpt_sum_read t set (m18, m21) = select ... rank() over ()... from rpt_sum_read ...
		update rpt_sum_read t set (m19, m22) = select ... rank() over ()... from rpt_sum_read ...
		update rpt_sum_read t set (m20, m23) = select ... rank() over ()... from rpt_sum_read ...
		--更新产销计划(哈尔滨新的企划表BS_PLAN维度只能到用水大类，报表体系维度是到用水小类)
		update rpt_sum_read set ... select ... from bs_plan
		--计划完成情况
		update rpt_sum_read set ... select ... from rpt_sum_read

	procedure 账务明细统计(a_month in varchar2);
		--1.生成粒度 删除代号维度，增加最小维度 应收事务 以区分基建、补缴、计划抄表应收等
		delete rpt_sum_detail t where t.u_month = a_month;
		insert into rpt_sum_detail select ... from mv_meter_prop, view_rectrans_used vr
		--2.应收信息 
		execute immediate 'truncate table rpt_sum_temp';
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m
		insert into rpt_sum_detail select ... from rpt_sum_temp
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--3.总销账
		execute immediate 'truncate table rpt_sum_temp';    
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		insert into rpt_sum_detail select ... from rpt_sum_detail
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--4.增加消防水鹤
		execute immediate 'truncate table rpt_sum_temp';		
		insert into rpt_sum_temp select ... from reclist rl,meterinfo
		insert into rpt_sum_detail select ... from rpt_sum_temp
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--5. 销以往
		execute immediate 'truncate table rpt_sum_temp';		
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m, payment pp
		insert into rpt_sum_detail select ... from rpt_sum_temp
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--6.销当月
		execute immediate 'truncate table rpt_sum_temp';    
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m, payment pp
		insert into rpt_sum_detail select ... from rpt_sum_temp
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--7.欠当月
		execute immediate 'truncate table rpt_sum_temp';
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m
		insert into rpt_sum_detail select ... from rpt_sum_temp
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		--单价
		update rpt_sum_detail t1 set ... select ... from price_prop t2
		--因哈尔滨减免水量栏位rdadjsl全为0 故上述抓取需调整，start
		execute immediate 'truncate table rpt_sum_temp';    
		insert into rpt_sum_temp select ... from reclist rl, meterinfo m, view_recdetail_01 rd
		update rpt_sum_detail t set ... select ... from rpt_sum_temp tmp
		update rpt_sum_detail set t20 = '补当', t19 = '基建' where t16 in ('u','v') and u_month = a_month;
		update rpt_sum_detail set t20 = '补当', t19 = '补缴' where t16 in ('13') and u_month = a_month;
		update rpt_sum_detail set t20 = '补当', t19 = '稽查' where t16 in ('14') and u_month = a_month;
		update rpt_sum_detail set t20 = '补当', t19 = '稽查' where t16 in ('21') and u_month = a_month;
		update rpt_sum_detail set t20 = '补当', t19 = '呆账' where t16 in ('d') and u_month = a_month;
		update rpt_sum_detail set sp21 = 1 where id in (select min(id) from rpt_sum_detail x where u_month = a_month group by ofagent)and u_month = a_month;

		update rpt_sum_detail t set ... select ... from bs_plan t
		--计划完成情况
		update rpt_sum_detail t set ... select ... from rpt_sum_detail t1

	procedure 收费统计(a_month in varchar2);
		delete rpt_sum_charge t where t.u_month = a_month;
		--生成粒度
		insert into rpt_sum_charge select ... from payment p, mv_meter_prop m
		delete rpt_sum_temp;
		--单价
		update rpt_sum_charge t1 set ... select ... from price_prop t2
		------总销账
		delete rpt_sum_temp;
		insert into rpt_sum_temp from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p,(select pid from rpt_sum_pid where u_month = a_month) pp
		---补充view_meter_prop不存在的维度----
		insert into rpt_sum_charge select ... from rpt_sum_temp
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p union select ... from payment p, mv_meter_prop m
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		------基建
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		------补缴
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		------稽核
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		------补当销账
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		---补充view_meter_prop不存在的维度----
		insert into rpt_sum_charge select ... from rpt_sum_charge
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		-------------销以往-----------------
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		update rpt_sum_charge t set ... select ...from rpt_sum_temp tmp
		--销当月
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m,payment p
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		-------------预存自动抵扣-----------------
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment py,reclist rl,mv_reclist_charge_02 rd,mv_meter_prop m
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		-------------实收-----------------
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment py, mv_meter_prop m,(select pid from rpt_sum_pid where u_month = a_month) pp
		update rpt_sum_charge t set ... select ... from rpt_sum_temp tmp
		-------更新生成日期
		update rpt_sum_charge t set t.tpdate = sysdate,
		t.company =(select smfpid from sysmanaframe sy where sy.smfid = t.ofagent),
		t.k9 = round((decode(nvl(k4, 0), 0, 1, k4) /decode(nvl(k3, 0), 0, 1, k3)),2)
		where t.u_month = a_month;

		update rpt_sum_charge t 
		set s14 =(select sum(decode(pdpiid, '01', pddj)) / sum(pddj) s from pricedetail x where pddj > 0 and pdpfid = t.watertype)
		where t.u_month = a_month;

		update rpt_sum_charge t
		set s12 = (nvl(t.s6, 0) - nvl(t.s8, 0))  * s14, ---地区坐收水费分摊
		s13 = nvl(t.s8, 0)  * s14 ---银行水费分摊
		where charegetype = 'x' and t.u_month = a_month;
		--补充维度
		update rpt_sum_charge t
		set t16 = case  when substr(t.charge_client, 1, 2)='03' then '银行' 
		when substr(t.charge_client, 1, 2)='02' then '营业大厅'
		else '其它部门' end--客服中心、营销部、稽查科等部门销账 蔡俊平
		where u_month = a_month;

		update rpt_sum_charge t1 --科室
		set t1.t18 = (select oadept from operaccnt t where oaid =t1.sfy )
		where u_month = a_month;

	procedure 综合统计(a_month in varchar2);
		delete rpt_sum_total t where t.u_month = a_month;
		--生成粒度 到营业所
		insert into rpt_sum_total select ... from mv_meter_prop
		---补充view_meter_prop不存在的维度
		insert into rpt_sum_total select distinct ... from rpt_sum_read
		--单价
		update rpt_sum_total t1 select ... from price_prop t2
		--应收
		update rpt_sum_total t1 select ... from rpt_sum_read tmp
		--销以往
		update rpt_sum_total t select ... from rpt_sum_detail tmp
		--销当月
		update rpt_sum_total t select ... from rpt_sum_detail tmp
		-- 总销账
		update rpt_sum_total t select ... from rpt_sum_detail tmp
		---总欠费 (欠当月)
		update rpt_sum_total t select ... from rpt_sum_detail tmp
		---欠以往
		update rpt_sum_total t select ... from rpt_sum_detail tmp
		-------------实收--硬算---------------
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment py, mv_meter_prop m
		---补充view_meter_prop不存在的维度--rpt_sum_read--
		insert into rpt_sum_total select ... from rpt_sum_temp
		---补充view_meter_prop不存在的维度----
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		/*****上月******/
		update rpt_sum_total t1 select ... from rpt_sum_total t2
		/*去年同期*/
		update rpt_sum_total t1 select ... from rpt_sum_total t2
		/*当年*/
		update rpt_sum_total t1 select ... from rpt_sum_total t2
		/**期初欠费*/
		update rpt_sum_total t1 select ... from rpt_sum_detail tmp
		--本季应收
		update rpt_sum_total t1 select ... from rpt_sum_detail tmp
		--本季总销账
		update rpt_sum_total t1 select ... from rpt_sum_detail tmp
		--预存抵扣
		update rpt_sum_total t1 select ... from rpt_sum_detail tmp
		--指标
		update rpt_sum_total t1 select ... from rpt_sum_read tmp
		--冲往月红票笔数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment p, reclist rl, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		--预存不平数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment p, reclist rl, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		--银行单边帐数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from bank_dz_mx b, payment p, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		--自来水单边帐数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from bank_dz_mx b, payment p, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		--应收不平数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		-- 交易作废数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from payment p, reclist rl, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		托出未销账数
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from reclist rl, mv_meter_prop m
		update rpt_sum_total t select ... from rpt_sum_temp tmp
		--更新产销计划
		update rpt_sum_total t select ... from salesplan t0

	procedure 考核表统计(a_month varchar2);
		--删除考核表的中间表数据
		delete from bs_wbs;
		--插入考核表的中间表数据
		insert into bs_wbs select ...from meterinfo
		--删除考核表当月的报表数据
		delete rpt_wbs_chk_sum where u_month = a_month;
		--插入考核表的报表数据
		insert into rpt_wbs_chk_sum select ...from bs_wbs bs;
		update rpt_wbs_chk_sum rpt 
			set c_charge=(select count(miid) from meterinfo mi where ...)--直接收费表数
			set c_chk=(select count(meterno) from rpt_wbs_chk_sum t where ...)--考核子表数
			set c_all_charge=(select count(miid) from meterinfo mi, rpt_wbs_chk_sum t where ...)--所有收费表数
			set sum_s=(select sum(mrsl) from view_meterreadall m where ...)--本表量
			set sum_child=(select sum(mrsl) from view_meterreadall mr, rpt_wbs_chk_sum t where ...)--子表量
			set sum_charge=(select sum(mrsl) from view_meterreadall mr, meterinfo mi , rpt_wbs_chk_sum twhere ...)--直接收费表量
			set sum_all_charge=(select sum(mrsl) from view_meterreadall mr, meterinfo mi , rpt_wbs_chk_sum t where ...)--所有收费表量

	procedure 产销计划初始化(a_month varchar2);
		select ... from salesplan where month = to_char(add_months(to_date(a_month, 'yyyy.mm'), -1),'yyyy.mm')
		if v_num < 1 then
			insert into salesplan values v_salesplan;

	procedure 绩效考核统计(a_month in varchar2);
		---生成初始表结构
		delete 工作量计件制 t where t.umonth = a_month;
		insert into 工作量计件制 select ... from operaccnt oa, operaccntrole oar, operrole opr
		---系统水表数量
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from mv_meter_prop t
		update 工作量计件制 t set ... select ... from rpt_sum_temp
		---系统水表数量
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from mv_meter_prop t
		update 工作量计件制 t set ... select ... from rpt_sum_temp
		---实际抄表数量
		delete rpt_sum_temp;
		insert into rpt_sum_temp select ... from view_meterreadall mr, mv_meter_prop t
		update 工作量计件制 t set ... select ... from rpt_sum_temp
		--实际工作量
		update 工作量计件制 t
		set workcountd = metercountd * oasalary4 / 100, --单月实际工作量
		workcounts = metercounts * oasalary4 / 100, --双月实际工作量
		workcountave =(workcountd + workcounts) / 2 --平均工作量
		where t.umonth = a_month;

	procedure 财务资金统计(a_month in varchar2);
		delete rpt_sum_cwzjbb t where t.账务月份 = a_month;
		--通过实收的票面金额、销账金分析营业所、银行的销账情况
		--财务资金报表
		insert into rpt_sum_cwzjbb select ... from reclist rl, mv_reclist_charge_02 rd, mv_meter_prop m, payment p
		insert into rpt_sum_cwzjbb select ... from payment p,mv_meter_prop m
		delete rpt_dhz;
		--呆坏账明细，每天晚上和中间表执行20140822
		insert into rpt_dhz select ... from reclist,view_reclist_charge_01

	procedure gis数据生成;
		delete view_bcustinfo1;
		insert into view_bcustinfo1 select ... from reclist rl
		
		delete view_breclist1;
		insert into view_breclist1 select ...from view_bcustinfo1 vb, reclist rl
		
		delete view_bcustinfo@gis_link;
		insert into view_bcustinfo@gis_link select * from view_bcustinfo1;

		delete view_breclist@gis_link;
		insert into view_breclist@gis_link select * from view_breclist1;
	
	procedure 水价调整0201;   
		select * from pricedetail where pdpfid not in ('A0101','A0102','A0103','A0104','A06','A0107','A0108') and pdpiid = '02' 
		if rec_price.pddj = 0.8 then
			update pricedetail set pddj = 0.95 where current of cur_price;
		elsif rec_price.pddj = 1.2 then
			update pricedetail set pddj = 1.4 where current of cur_price;

	procedure 综合月报(a_month in varchar2);
		名称：		哈尔滨综合月报执行总过程
		作者:		韦政
		时间:		2012-05-04
		参数说明：	A_MONTH  账务月份
		用途 :		调用此过程可重算  1.预存存档  2.抄表统计 3.账务明细统计 4.收费统计 5.综合统计
		--------初始化中间表--------
		初始化中间表(a_month);
		--------预存存档--------
		if to_char(last_day(sysdate-1), 'yyyymmdd') =  to_char(sysdate-1, 'yyyymmdd') then
		预存存档(a_month);
		--银行开关设置 2014/05/31
		--每月末做完预存归档后，将银行实时联网收费开关打开，哈尔滨银行除外
		--如果今后哈尔滨银行开始联网收费，请在此处去掉对哈尔滨银行的限制
		update syspara set spvalue = 'y'
		where spid in ('b001','b002','b003','b004','b005','b006','b007','b008','b009','b010','b011')   --20170331 限制邮储银行
		and spid<>'b011' --20200424 限制邮储银行
		and spid<>'b010' --20200710 限制龙江银行

		抄表统计(a_month);
		账务明细统计(a_month);
		收费统计(a_month);
		综合统计(a_month);
		财务资金统计(a_month);
		pg_ewide_job_hrb.月售水情况归档_1(a_month);

		--资金回收_中间表
		delete 资金回收_中间表 t where t.月份=a_month;
		insert into  资金回收_中间表 t select ... from v_资金回收报表2    
		-------------- 基建统计报表(每月第一天执行) -----------------
		pg_ewide_job_hrb2.prc_rpt_allot_sum(a_month,n_app,c_error);

	procedure 综合月报初始执行(s_month in varchar2, e_month in varchar2);
		综合月报(V_MONTH);


